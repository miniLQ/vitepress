import{_ as a,c as i,o as n,a0 as t}from"./chunks/framework.Cee10E_e.js";const g=JSON.parse('{"title":"华为电池核心之 battery_ui_capacity 模块代码解析","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"hw_charging/business/battery-core/battery_ui_capacity.md","filePath":"hw_charging/business/battery-core/battery_ui_capacity.md"}'),p={name:"hw_charging/business/battery-core/battery_ui_capacity.md"};function l(h,s,e,k,r,d){return n(),i("div",null,[...s[0]||(s[0]=[t(`<h1 id="华为电池核心之-battery-ui-capacity-模块代码解析" tabindex="-1">华为电池核心之 battery_ui_capacity 模块代码解析 <a class="header-anchor" href="#华为电池核心之-battery-ui-capacity-模块代码解析" aria-label="Permalink to &quot;华为电池核心之 battery_ui_capacity 模块代码解析&quot;">​</a></h1><h2 id="一、模块概述" tabindex="-1">一、模块概述 <a class="header-anchor" href="#一、模块概述" aria-label="Permalink to &quot;一、模块概述&quot;">​</a></h2><p><code>battery_ui_capacity</code> 模块是华为电源管理子系统中的<strong>用户界面电量显示驱动</strong>，负责将底层库仑计（Coulomb Counter）提供的原始 SOC（State of Charge）转换为用户友好、平滑、可靠的 UI 电量百分比。</p><p><strong>核心功能：</strong></p><ul><li><strong>电量平滑算法：</strong> 滑动窗口滤波，避免电量跳变</li><li><strong>充电状态管理：</strong> 充电/放电/满电等状态下的电量逻辑处理</li><li><strong>强制满电机制：</strong> 接近满电时自动切换到 100%</li><li><strong>电压校正算法：</strong> 通过电压阈值校正 SOC，防止虚电</li><li><strong>关机电量校正：</strong> 低电量时通过电压二次校验，避免意外关机</li><li><strong>假电量过滤：</strong> 支持硅基电池/ECM 模式等特殊场景的电量锁定</li><li><strong>SOC 异常检测：</strong> 监控电量突变并上报 DSM 故障</li></ul><p><strong>架构图：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│          Battery UI Capacity Module             │</span></span>
<span class="line"><span>└──────────┬──────────────────────────────────────┘</span></span>
<span class="line"><span>           │</span></span>
<span class="line"><span>    ┌──────┴──────┐</span></span>
<span class="line"><span>    │             │</span></span>
<span class="line"><span>┌───▼───┐   ┌────▼────┐</span></span>
<span class="line"><span>│Coul IC│   │ Voltage │</span></span>
<span class="line"><span>│  SOC  │   │  Check  │</span></span>
<span class="line"><span>└───┬───┘   └────┬────┘</span></span>
<span class="line"><span>    │            │</span></span>
<span class="line"><span>    └─────┬──────┘</span></span>
<span class="line"><span>          │</span></span>
<span class="line"><span>    ┌─────▼─────┐</span></span>
<span class="line"><span>    │ UI Filter │ ← 滑动窗口 + 充电状态检查</span></span>
<span class="line"><span>    └─────┬─────┘</span></span>
<span class="line"><span>          │</span></span>
<span class="line"><span>    ┌─────▼─────┐</span></span>
<span class="line"><span>    │VTH Correct│ ← 电压阈值校正</span></span>
<span class="line"><span>    └─────┬─────┘</span></span>
<span class="line"><span>          │</span></span>
<span class="line"><span>    ┌─────▼─────┐</span></span>
<span class="line"><span>    │Fake Filter│ ← 假电量过滤（硅基电池/ECM）</span></span>
<span class="line"><span>    └─────┬─────┘</span></span>
<span class="line"><span>          │</span></span>
<span class="line"><span>    ┌─────▼─────┐</span></span>
<span class="line"><span>    │ UI SOC(%) │ → power_supply → Android</span></span>
<span class="line"><span>    └───────────┘</span></span></code></pre></div><hr><h2 id="二、主要数据结构" tabindex="-1">二、主要数据结构 <a class="header-anchor" href="#二、主要数据结构" aria-label="Permalink to &quot;二、主要数据结构&quot;">​</a></h2><h3 id="_2-1-主设备结构体-bat-ui-capacity-device" tabindex="-1">2.1 主设备结构体 <code>bat_ui_capacity_device</code> <a class="header-anchor" href="#_2-1-主设备结构体-bat-ui-capacity-device" aria-label="Permalink to &quot;2.1 主设备结构体 \`bat_ui_capacity_device\`&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_ui_capacity_device {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delayed_work update_work;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 电量更新工作队列</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delayed_work wait_work;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 等待库仑计就绪工作队列</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wakeup_source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wakelock;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 唤醒锁</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mutex update_lock;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              // 更新互斥锁</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 充电状态 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> charge_status;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     // CHARGING/DISCHARGING/FULL/NOT_CHARGING</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* SOC 缩放参数 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ui_cap_zero_offset;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // UI 电量零点偏移（%）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> soc_at_term;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                       // 终止充电时的 SOC（用于缩放）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 电量值 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ui_capacity;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                       // 当前 UI 电量（%）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ui_prev_capacity;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // 上次 UI 电量（%）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev_soc;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                          // 上次记录的 SOC</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 电池状态 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_exist;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                         // 电池是否存在</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_volt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                          // 电池电压（mV）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_cur;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                           // 电池电流（mA）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_temp;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                          // 电池温度（0.1°C）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_max_volt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      // 电池最大电压（mV）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 滑动窗口滤波器 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> capacity_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BUC_WINDOW_LEN];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 电量滤波数组（默认 10 个元素）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> capacity_sum;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      // 滤波器总和</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> capacity_filter_count;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // 滤波器计数器</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> filter_len;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                        // 滤波器长度</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 电压校正 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vth_correct_en;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 电压阈值校正使能</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_ui_soc_calibration_para </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">vth_soc_calibration_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 强制满电 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chg_force_full_soc_thld;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           // 强制满电 SOC 阈值（默认 95%）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chg_force_full_count;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              // 强制满电计数器</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chg_force_full_wait_time;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 强制满电等待时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 关机电量校正 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> correct_shutdown_soc_en;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           // 关机校正使能</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shutdown_flag;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     // 关机校正标志</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shutdown_cap;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      // 关机电量阈值（默认 1%）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shutdown_gap;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      // 关机电量间隙（默认 2%）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shutdown_vth;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      // 关机电压阈值（mV）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 监控参数 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u16 monitoring_interval;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               // 当前监控间隔（ms）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> interval_charging;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                 // 充电监控间隔（默认 5s）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> interval_normal;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   // 正常监控间隔（默认 10s）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> interval_lowtemp;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // 低温监控间隔（默认 5s）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> soc_monitor_limit;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                 // SOC 变化监控限制（默认 15%）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> soc_monitor_flag;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // SOC 监控状态标志</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> soc_monitor_cnt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   // SOC 监控计数器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 其他 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wait_cnt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                          // 等待计数器</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wait_max_time;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     // 最大等待时间（默认 120s）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cap_jump_th;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                       // 电量跳变阈值（默认 7%）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u32 disable_pre_vol_check;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // 禁用低电量电压检查</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> notifier_block event_nb;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 充电事件通知块</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h3 id="_2-2-电压-soc-校正参数-bat-ui-soc-calibration-para" tabindex="-1">2.2 电压-SOC 校正参数 <code>bat_ui_soc_calibration_para</code> <a class="header-anchor" href="#_2-2-电压-soc-校正参数-bat-ui-soc-calibration-para" aria-label="Permalink to &quot;2.2 电压-SOC 校正参数 \`bat_ui_soc_calibration_para\`&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_ui_soc_calibration_para {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> soc;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 校正后的 SOC 阈值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> volt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 触发校正的电压阈值（mV）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p><strong>用途：</strong> 放电时，若 SOC &lt; <code>soc</code> 且电压 ≥ <code>volt</code>，则锁定电量为 <code>soc</code>，避免虚电掉电过快。</p><h3 id="_2-3-假电量策略-bat-fake-cap-policy" tabindex="-1">2.3 假电量策略 <code>bat_fake_cap_policy</code> <a class="header-anchor" href="#_2-3-假电量策略-bat-fake-cap-policy" aria-label="Permalink to &quot;2.3 假电量策略 \`bat_fake_cap_policy\`&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fake_cap_policy {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> index;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      // 策略索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fake_cap_range range;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 电量范围</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> target_cap;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                 // 目标锁定电量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> policy_enable;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              // 策略使能开关</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> func_type;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // 功能类型（INIT/NOTIFY）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">func)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // 检测函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p><strong>预定义策略：</strong></p><table tabindex="0"><thead><tr><th>索引</th><th>源</th><th>电量范围</th><th>锁定值</th><th>触发条件</th><th>说明</th></tr></thead><tbody><tr><td>0</td><td>BAT_MODEL</td><td>0-100%</td><td>0%</td><td>检测到硅基电池</td><td>防止石墨电池误识别</td></tr><tr><td>1</td><td>ECM_MODE</td><td>0-1%</td><td>1%</td><td>ECM 模式触发</td><td>延长极低功耗模式续航</td></tr></tbody></table><hr><h2 id="三、核心算法" tabindex="-1">三、核心算法 <a class="header-anchor" href="#三、核心算法" aria-label="Permalink to &quot;三、核心算法&quot;">​</a></h2><h3 id="_3-1-电量平滑算法-滑动窗口滤波" tabindex="-1">3.1 电量平滑算法（滑动窗口滤波） <a class="header-anchor" href="#_3-1-电量平滑算法-滑动窗口滤波" aria-label="Permalink to &quot;3.1 电量平滑算法（滑动窗口滤波）&quot;">​</a></h3><p><strong>实现函数：</strong> <code>bat_ui_capacity_pulling_filter()</code></p><p><strong>算法原理：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">滑动窗口数组：</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">capacity_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">当前和：capacity_sum</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">步骤：</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 移除最旧的值：capacity_sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> capacity_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[index]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 插入新值：</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">capacity_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[index] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> curr_capacity</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 更新总和：capacity_sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> capacity_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[index]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 返回平均值：capacity_sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> filter_len</span></span></code></pre></div><p><strong>示例：</strong></p><table tabindex="0"><thead><tr><th>步骤</th><th>输入 SOC</th><th>滤波器数组</th><th>总和</th><th>输出 UI SOC</th></tr></thead><tbody><tr><td>初始化</td><td>50</td><td>[50,50,50,50,50,50,50,50,50,50]</td><td>500</td><td>50</td></tr><tr><td>更新 1</td><td>52</td><td>[52,50,50,50,50,50,50,50,50,50]</td><td>502</td><td>50</td></tr><tr><td>更新 2</td><td>54</td><td>[52,54,50,50,50,50,50,50,50,50]</td><td>504</td><td>50</td></tr><tr><td>...更新 5 次...</td><td>60</td><td>[52,54,56,56,58,60,50,50,50,50]</td><td>536</td><td>53</td></tr></tbody></table><p><strong>设计目的：</strong> 防止库仑计瞬时波动导致的 UI 电量跳变，提供平滑的用户体验。</p><h3 id="_3-2-soc-缩放算法" tabindex="-1">3.2 SOC 缩放算法 <a class="header-anchor" href="#_3-2-soc-缩放算法" aria-label="Permalink to &quot;3.2 SOC 缩放算法&quot;">​</a></h3><p><strong>公式：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ui_capacity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (raw_soc × </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> soc_at_term </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ui_cap_zero_offset</span></span></code></pre></div><p><strong>参数说明：</strong></p><ul><li><code>raw_soc</code>: 库仑计原始 SOC（0-100%）</li><li><code>soc_at_term</code>: 充电终止时的 SOC（如老化电池可能只能充到 95%）</li><li><code>ui_cap_zero_offset</code>: UI 零点偏移（用于补偿库仑计零点漂移）</li></ul><p><strong>示例 1（电池老化）：</strong></p><table tabindex="0"><thead><tr><th>参数</th><th>值</th></tr></thead><tbody><tr><td>raw_soc</td><td>95</td></tr><tr><td>soc_at_term</td><td>95</td></tr><tr><td>ui_cap_zero_offset</td><td>0</td></tr><tr><td><strong>ui_capacity</strong></td><td><strong>100</strong></td></tr></tbody></table><p><strong>示例 2（零点漂移补偿）：</strong></p><table tabindex="0"><thead><tr><th>参数</th><th>值</th></tr></thead><tbody><tr><td>raw_soc</td><td>5</td></tr><tr><td>soc_at_term</td><td>100</td></tr><tr><td>ui_cap_zero_offset</td><td>2</td></tr><tr><td><strong>ui_capacity</strong></td><td><strong>3</strong></td></tr></tbody></table><h3 id="_3-3-充电状态检查算法-bat-ui-capacity-charge-status-check" tabindex="-1">3.3 充电状态检查算法 <code>bat_ui_capacity_charge_status_check()</code> <a class="header-anchor" href="#_3-3-充电状态检查算法-bat-ui-capacity-charge-status-check" aria-label="Permalink to &quot;3.3 充电状态检查算法 \`bat_ui_capacity_charge_status_check()\`&quot;">​</a></h3><h4 id="_3-3-1-充电中-charging" tabindex="-1">3.3.1 充电中（CHARGING） <a class="header-anchor" href="#_3-3-1-充电中-charging" aria-label="Permalink to &quot;3.3.1 充电中（CHARGING）&quot;">​</a></h4><p><strong>强制满电逻辑：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (curr_capacity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 95</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    chg_force_full_count</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (chg_force_full_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chg_force_full_wait_time) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 等待 24 分钟后强制切换到 100%</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        curr_capacity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>设计理念：</strong> 避免长时间停留在 99%，提升用户体验（默认 24 分钟）。</p><h4 id="_3-3-2-满电-full" tabindex="-1">3.3.2 满电（FULL） <a class="header-anchor" href="#_3-3-2-满电-full" aria-label="Permalink to &quot;3.3.2 满电（FULL）&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (bat_volt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_max_volt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;"> 150mV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    curr_capacity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 强制显示 100%</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>设计理念：</strong> 充电器报告满电后，只要电压未掉到再充电阈值，持续显示 100%。</p><h4 id="_3-3-3-放电中-discharging-not-charging" tabindex="-1">3.3.3 放电中（DISCHARGING/NOT_CHARGING） <a class="header-anchor" href="#_3-3-3-放电中-discharging-not-charging" aria-label="Permalink to &quot;3.3.3 放电中（DISCHARGING/NOT_CHARGING）&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ui_prev_capacity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> curr_capacity) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EPERM;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 拒绝更新，放电时电量不能上升</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-4-电压阈值校正算法-bat-ui-capacity-vth-correct-soc" tabindex="-1">3.4 电压阈值校正算法 <code>bat_ui_capacity_vth_correct_soc()</code> <a class="header-anchor" href="#_3-4-电压阈值校正算法-bat-ui-capacity-vth-correct-soc" aria-label="Permalink to &quot;3.4 电压阈值校正算法 \`bat_ui_capacity_vth_correct_soc()\`&quot;">​</a></h3><p><strong>校正流程：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">输入：curr_capacity, bat_volt</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">配置：vth_soc_calibration_data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { soc: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">15</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, volt: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 电压 ≥ 3500mV 时，SOC 锁定到 15%</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { soc: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, volt: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3450</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 电压 ≥ 3450mV 时，SOC 锁定到 5%</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((curr_capacity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> vth_soc_calibration_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].soc) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        (bat_volt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> vth_soc_calibration_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].volt)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> vth_soc_calibration_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].soc;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 校正电量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> curr_capacity;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 无需校正</span></span></code></pre></div><p><strong>示例场景：</strong></p><table tabindex="0"><thead><tr><th>原始 SOC</th><th>电池电压</th><th>校正后 SOC</th><th>说明</th></tr></thead><tbody><tr><td>3%</td><td>3460mV</td><td>5%</td><td>电压 ≥ 3450mV，锁定到 5%</td></tr><tr><td>12%</td><td>3520mV</td><td>15%</td><td>电压 ≥ 3500mV，锁定到 15%</td></tr><tr><td>18%</td><td>3520mV</td><td>18%</td><td>SOC 已高于阈值，无需校正</td></tr></tbody></table><p><strong>应用场景：</strong> 防止虚电（电池阻抗大、温度低等导致电压虚高）。</p><h3 id="_3-5-关机电量校正算法-bat-ui-capacity-correct-shutdown-soc-by-vth" tabindex="-1">3.5 关机电量校正算法 <code>bat_ui_capacity_correct_shutdown_soc_by_vth()</code> <a class="header-anchor" href="#_3-5-关机电量校正算法-bat-ui-capacity-correct-shutdown-soc-by-vth" aria-label="Permalink to &quot;3.5 关机电量校正算法 \`bat_ui_capacity_correct_shutdown_soc_by_vth()\`&quot;">​</a></h3><p><strong>校正条件：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 使能开关：correct_shutdown_soc_en </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 放电状态：DISCHARGING 或 NOT_CHARGING</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 温度范围：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">°C ≤ bat_temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">°C</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 电量区间：shutdown_cap </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cap ≤ shutdown_cap </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shutdown_gap</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   （默认：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cap ≤ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 电压检测：bat_volt ≤ shutdown_vth（通过 OCV 表查询 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 电压）</span></span></code></pre></div><p><strong>校正流程：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (满足上述条件) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 连续 3 次采样验证电压</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voltage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> coul_interface_get_battery_voltage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voltage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shutdown_vth)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 电压恢复，取消校正</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        count</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        msleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3 次均低于阈值，校正到 shutdown_cap</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shutdown_cap;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>设计目的：</strong> 防止库仑计 SOC 报 2-3% 但电压已低于关机阈值，导致意外关机。</p><h3 id="_3-6-假电量过滤算法-bat-fake-cap-filter" tabindex="-1">3.6 假电量过滤算法 <code>bat_fake_cap_filter()</code> <a class="header-anchor" href="#_3-6-假电量过滤算法-bat-fake-cap-filter" aria-label="Permalink to &quot;3.6 假电量过滤算法 \`bat_fake_cap_filter()\`&quot;">​</a></h3><p><strong>过滤逻辑：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">输入：cap</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">输出：</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(所有生效策略的 target_cap, cap)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">示例：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">策略 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">（硅基电池）：range [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]，target</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">，enabled</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">策略 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">（ECM 模式）：range [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]，target</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">，enabled</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">case </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: cap</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  → 策略 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 生效（</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 在 [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]），target</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  → 策略 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 不生效（</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 不在 [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  → 返回 </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">case </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: cap</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">（ECM 模式下）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  → 策略 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 生效，target</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  → 策略 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 生效，target</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  → 返回 </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">（硅基电池优先级更高）</span></span></code></pre></div><p><strong>应用场景：</strong></p><ol><li><strong>硅基电池检测：</strong> 检测到石墨电池被误识别为硅基电池时，强制显示 0%，提醒用户更换</li><li><strong>ECM 模式：</strong> 极低功耗模式下，锁定电量到 1%，延长续航时间</li></ol><hr><h2 id="四、soc-异常监控机制" tabindex="-1">四、SOC 异常监控机制 <a class="header-anchor" href="#四、soc-异常监控机制" aria-label="Permalink to &quot;四、SOC 异常监控机制&quot;">​</a></h2><h3 id="_4-1-监控流程-bat-ui-check-soc-vary-err" tabindex="-1">4.1 监控流程 <code>bat_ui_check_soc_vary_err()</code> <a class="header-anchor" href="#_4-1-监控流程-bat-ui-check-soc-vary-err" aria-label="Permalink to &quot;4.1 监控流程 \`bat_ui_check_soc_vary_err()\`&quot;">​</a></h3><p><strong>触发条件：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 监控间隔：每 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 秒检测一次</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 温度条件：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">°C ≤ bat_temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 45</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">°C（确保温度稳定）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 电量区间：</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SOC </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 90</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">（避免边界干扰）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SOC 变化：</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">delta_soc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ≥ soc_monitor_limit（默认 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">15</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">）</span></span></code></pre></div><p><strong>DSM 上报内容：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gauge_name: maxim_ds28e30</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">start: ui_soc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">85</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, raw_soc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">88</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, volt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, cur</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, temp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">250</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end: ui_soc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">68</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, raw_soc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">70</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, volt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3900</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, cur</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, temp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">248</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">delta_soc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">17</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, soc_monitor_limit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">15</span></span></code></pre></div><p><strong>典型故障原因：</strong></p><ul><li>库仑计校准失败</li><li>电池内阻突变（老化/损坏）</li><li>OCV 表不匹配</li><li>温度传感器异常</li></ul><hr><h2 id="五、工作流程" tabindex="-1">五、工作流程 <a class="header-anchor" href="#五、工作流程" aria-label="Permalink to &quot;五、工作流程&quot;">​</a></h2><h3 id="_5-1-初始化流程" tabindex="-1">5.1 初始化流程 <a class="header-anchor" href="#_5-1-初始化流程" aria-label="Permalink to &quot;5.1 初始化流程&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>probe()</span></span>
<span class="line"><span>  ├─ 解析 DTS 参数</span></span>
<span class="line"><span>  │   ├─ soc_at_term（SOC 缩放因子）</span></span>
<span class="line"><span>  │   ├─ filter_len（滤波器长度）</span></span>
<span class="line"><span>  │   ├─ vth_correct_para（电压校正参数）</span></span>
<span class="line"><span>  │   ├─ shutdown_correct_para（关机校正参数）</span></span>
<span class="line"><span>  │   └─ monitoring_interval（监控间隔）</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  ├─ 初始化数据</span></span>
<span class="line"><span>  │   ├─ charge_status = DISCHARGING</span></span>
<span class="line"><span>  │   ├─ chg_force_full_wait_time = 24 分钟</span></span>
<span class="line"><span>  │   └─ ui_capacity = -1（未初始化标志）</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  ├─ 注册充电事件通知</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  ├─ 启动等待工作队列（wait_work）</span></span>
<span class="line"><span>  │   └─ 等待库仑计就绪（最多 120 秒）</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  └─ 二次初始化</span></span>
<span class="line"><span>      ├─ 读取上次关机电量（last_capacity）</span></span>
<span class="line"><span>      ├─ 比较当前电量（curr_capacity）</span></span>
<span class="line"><span>      ├─ 若跳变 &lt; 7%，使用 last_capacity</span></span>
<span class="line"><span>      ├─ 初始化滑动窗口滤波器</span></span>
<span class="line"><span>      └─ 启动更新工作队列（update_work）</span></span></code></pre></div><h3 id="_5-2-更新工作队列-bat-ui-capacity-work" tabindex="-1">5.2 更新工作队列 <code>bat_ui_capacity_work()</code> <a class="header-anchor" href="#_5-2-更新工作队列-bat-ui-capacity-work" aria-label="Permalink to &quot;5.2 更新工作队列 \`bat_ui_capacity_work()\`&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>每 5-10 秒执行一次：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>1. 获取 wakelock（防止休眠）</span></span>
<span class="line"><span>2. 更新电池信息</span></span>
<span class="line"><span>   ├─ bat_exist（电池存在性）</span></span>
<span class="line"><span>   ├─ bat_volt（电压）</span></span>
<span class="line"><span>   ├─ bat_cur（电流）</span></span>
<span class="line"><span>   └─ bat_temp（温度）</span></span>
<span class="line"><span>3. 读取库仑计 SOC</span></span>
<span class="line"><span>4. SOC 缩放处理</span></span>
<span class="line"><span>   └─ ui_cap = (raw_soc × 100) / soc_at_term - offset</span></span>
<span class="line"><span>5. 充电状态检查</span></span>
<span class="line"><span>   ├─ 充电中：强制满电计时器</span></span>
<span class="line"><span>   ├─ 满电：电压保持 100%</span></span>
<span class="line"><span>   └─ 放电：单向递减检查</span></span>
<span class="line"><span>6. 电压阈值校正</span></span>
<span class="line"><span>7. 关机电量校正</span></span>
<span class="line"><span>8. 滑动窗口滤波</span></span>
<span class="line"><span>9. 假电量过滤</span></span>
<span class="line"><span>10. 异常检查</span></span>
<span class="line"><span>    ├─ 放电时 SOC 不能上升</span></span>
<span class="line"><span>    └─ 充电时 SOC 不能下降（直流充电除外）</span></span>
<span class="line"><span>11. 更新 UI 电量</span></span>
<span class="line"><span>    ├─ ui_capacity = 平滑后的 SOC</span></span>
<span class="line"><span>    └─ power_supply_changed(&quot;Battery&quot;)</span></span>
<span class="line"><span>12. SOC 异常监控（每 60s）</span></span>
<span class="line"><span>13. 释放 wakelock</span></span>
<span class="line"><span>14. 调整监控间隔</span></span>
<span class="line"><span>    ├─ 充电中：5 秒</span></span>
<span class="line"><span>    ├─ 低温（&lt; -5°C）：5 秒</span></span>
<span class="line"><span>    └─ 正常放电：10 秒</span></span>
<span class="line"><span>15. 重新调度工作队列</span></span></code></pre></div><hr><h2 id="六、dts-配置" tabindex="-1">六、DTS 配置 <a class="header-anchor" href="#六、dts-配置" aria-label="Permalink to &quot;六、DTS 配置&quot;">​</a></h2><h3 id="_6-1-主配置示例" tabindex="-1">6.1 主配置示例 <a class="header-anchor" href="#_6-1-主配置示例" aria-label="Permalink to &quot;6.1 主配置示例&quot;">​</a></h3><div class="language-dts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_ui_capacity {</span></span>
<span class="line"><span>    compatible = &quot;huawei,battery_ui_capacity&quot;;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* SOC 缩放参数 */</span></span>
<span class="line"><span>    soc_at_term = &lt;100&gt;;         // 充电终止 SOC（老化电池可能 &lt; 100）</span></span>
<span class="line"><span>    ui_cap_zero_offset = &lt;0&gt;;    // UI 零点偏移（%）</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 滑动窗口滤波器 */</span></span>
<span class="line"><span>    filter_len = &lt;10&gt;;           // 滤波器长度（1-10）</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 监控间隔 */</span></span>
<span class="line"><span>    monitoring_interval_normal = &lt;10000&gt;;     // 正常模式 10s</span></span>
<span class="line"><span>    monitoring_interval_charging = &lt;5000&gt;;    // 充电模式 5s</span></span>
<span class="line"><span>    monitoring_interval_lowtemp = &lt;5000&gt;;     // 低温模式 5s</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* SOC 异常监控 */</span></span>
<span class="line"><span>    soc_monitor_limit = &lt;15&gt;;    // SOC 变化阈值 15%</span></span>
<span class="line"><span>    cap_jump_th = &lt;7&gt;;           // 开机电量跳变阈值 7%</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 电压阈值校正 */</span></span>
<span class="line"><span>    vth_correct_en = &lt;1&gt;;</span></span>
<span class="line"><span>    vth_correct_para = &lt;</span></span>
<span class="line"><span>        15 3500    // SOC&lt;15% 且 V≥3500mV → 锁定 15%</span></span>
<span class="line"><span>        5  3450    // SOC&lt;5% 且 V≥3450mV → 锁定 5%</span></span>
<span class="line"><span>    &gt;;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 关机电量校正 */</span></span>
<span class="line"><span>    correct_shutdown_soc_en = &lt;1&gt;;</span></span>
<span class="line"><span>    shutdown_cap = &lt;1&gt;;          // 关机电量下限 1%</span></span>
<span class="line"><span>    shutdown_gap = &lt;2&gt;;          // 校正区间 [1%, 3%]</span></span>
<span class="line"><span>    shutdown_vth = &lt;3380&gt;;       // 关机电压阈值 3380mV</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 等待超时 */</span></span>
<span class="line"><span>    wait_max_time = &lt;120000&gt;;    // 等待库仑计就绪最大 120s</span></span>
<span class="line"><span>};</span></span></code></pre></div><h3 id="_6-2-假电量过滤配置" tabindex="-1">6.2 假电量过滤配置 <a class="header-anchor" href="#_6-2-假电量过滤配置" aria-label="Permalink to &quot;6.2 假电量过滤配置&quot;">​</a></h3><div class="language-dts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_fake_cap {</span></span>
<span class="line"><span>    compatible = &quot;huawei,battery_fake_cap&quot;;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 支持的假电量源 */</span></span>
<span class="line"><span>    fake_src_support = &lt;0 1&gt;;</span></span>
<span class="line"><span>    // 0: BAT_FAKE_CAP_SRC_BAT_MODEL（硅基电池检测）</span></span>
<span class="line"><span>    // 1: BAT_FAKE_CAP_SRC_ECM_MODE（ECM 模式）</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 延迟启动时间（等待电池信息就绪） */</span></span>
<span class="line"><span>    start_work_wait_time = &lt;5000&gt;;  // 5 秒</span></span>
<span class="line"><span>};</span></span></code></pre></div><hr><h2 id="七、外部接口" tabindex="-1">七、外部接口 <a class="header-anchor" href="#七、外部接口" aria-label="Permalink to &quot;七、外部接口&quot;">​</a></h2><h3 id="_7-1-获取-ui-电量-bat-ui-capacity" tabindex="-1">7.1 获取 UI 电量 <code>bat_ui_capacity()</code> <a class="header-anchor" href="#_7-1-获取-ui-电量-bat-ui-capacity" aria-label="Permalink to &quot;7.1 获取 UI 电量 \`bat_ui_capacity()\`&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_ui_capacity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>返回值：</strong> UI 电量百分比（0-100%），经过所有过滤和平滑处理。</p><p><strong>调用路径：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Android Framework</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>power_supply.capacity (sysfs)</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>battery_core.c</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>bat_ui_capacity()</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>bat_fake_cap_filter()  // 假电量过滤</span></span></code></pre></div><h3 id="_7-2-获取原始电量-bat-ui-raw-capacity" tabindex="-1">7.2 获取原始电量 <code>bat_ui_raw_capacity()</code> <a class="header-anchor" href="#_7-2-获取原始电量-bat-ui-raw-capacity" aria-label="Permalink to &quot;7.2 获取原始电量 \`bat_ui_raw_capacity()\`&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_ui_raw_capacity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>返回值：</strong> 原始电量（库仑计直接输出），仅经过假电量过滤，未经过平滑和校正。</p><p><strong>用途：</strong> 调试、日志记录。</p><h3 id="_7-3-同步滤波器-bat-ui-capacity-sync-filter" tabindex="-1">7.3 同步滤波器 <code>bat_ui_capacity_sync_filter()</code> <a class="header-anchor" href="#_7-3-同步滤波器-bat-ui-capacity-sync-filter" aria-label="Permalink to &quot;7.3 同步滤波器 \`bat_ui_capacity_sync_filter()\`&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_ui_capacity_sync_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> rep_soc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> round_soc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> base</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>功能：</strong> 外部强制同步滑动窗口滤波器（如充电器主动上报电量）。</p><p><strong>参数：</strong></p><ul><li><code>rep_soc</code>: 上报的 SOC（基于 base 缩放）</li><li><code>round_soc</code>: 四舍五入后的 SOC</li><li><code>base</code>: 缩放基数（如 1000 表示 rep_soc 是千分比）</li></ul><hr><h2 id="八、充电事件处理" tabindex="-1">八、充电事件处理 <a class="header-anchor" href="#八、充电事件处理" aria-label="Permalink to &quot;八、充电事件处理&quot;">​</a></h2><h3 id="_8-1-事件通知回调-bat-ui-capacity-event-notifier-call" tabindex="-1">8.1 事件通知回调 <code>bat_ui_capacity_event_notifier_call()</code> <a class="header-anchor" href="#_8-1-事件通知回调-bat-ui-capacity-event-notifier-call" aria-label="Permalink to &quot;8.1 事件通知回调 \`bat_ui_capacity_event_notifier_call()\`&quot;">​</a></h3><table tabindex="0"><thead><tr><th>事件</th><th>处理</th></tr></thead><tbody><tr><td><code>POWER_NE_CHARGING_START</code></td><td>charge_status = CHARGING</td></tr><tr><td><code>POWER_NE_CHARGING_STOP</code></td><td>charge_status = DISCHARGING</td></tr><tr><td><code>POWER_NE_CHARGING_SUSPEND</code></td><td>charge_status = NOT_CHARGING</td></tr></tbody></table><p><strong>附加动作：</strong></p><ul><li>复位 SOC 监控计数器</li><li>设置监控标志为 <code>BUC_STATUS_START</code></li><li>更新充电状态</li></ul><hr><h2 id="九、电源管理" tabindex="-1">九、电源管理 <a class="header-anchor" href="#九、电源管理" aria-label="Permalink to &quot;九、电源管理&quot;">​</a></h2><h3 id="_9-1-suspend-resume" tabindex="-1">9.1 Suspend/Resume <a class="header-anchor" href="#_9-1-suspend-resume" aria-label="Permalink to &quot;9.1 Suspend/Resume&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">suspend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    cancel_delayed_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">update_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 取消工作队列，省电</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    soc_monitor_flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BUC_STATUS_WAKEUP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    queue_delayed_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">update_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 立即更新电量</span></span></code></pre></div><h3 id="_9-2-shutdown-reboot" tabindex="-1">9.2 Shutdown/Reboot <a class="header-anchor" href="#_9-2-shutdown-reboot" aria-label="Permalink to &quot;9.2 Shutdown/Reboot&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shutdown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reboot_notifier_call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    保存当前 UI 电量到库仑计</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ↓</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    coul_interface_set_battery_last_capacity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ui_capacity)</span></span></code></pre></div><p><strong>用途：</strong> 下次开机时，若电量跳变 &lt; 7%，则使用上次保存值，避免开机电量突变。</p><hr><h2 id="十、调试技巧" tabindex="-1">十、调试技巧 <a class="header-anchor" href="#十、调试技巧" aria-label="Permalink to &quot;十、调试技巧&quot;">​</a></h2><h3 id="_10-1-查看实时-ui-电量" tabindex="-1">10.1 查看实时 UI 电量 <a class="header-anchor" href="#_10-1-查看实时-ui-电量" aria-label="Permalink to &quot;10.1 查看实时 UI 电量&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/class/power_supply/Battery/capacity</span></span></code></pre></div><h3 id="_10-2-查看原始库仑计-soc" tabindex="-1">10.2 查看原始库仑计 SOC <a class="header-anchor" href="#_10-2-查看原始库仑计-soc" aria-label="Permalink to &quot;10.2 查看原始库仑计 SOC&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 通过 debugfs（需要 coul 驱动支持）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/debug/coul/raw_soc</span></span></code></pre></div><h3 id="_10-3-模拟强制满电" tabindex="-1">10.3 模拟强制满电 <a class="header-anchor" href="#_10-3-模拟强制满电" aria-label="Permalink to &quot;10.3 模拟强制满电&quot;">​</a></h3><p>修改 battery_ui_capacity.c 中的等待时间：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 原代码：24 分钟</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chg_force_full_wait_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BUC_CHG_FORCE_FULL_TIME </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">interval_charging;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 调试代码：30 秒</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chg_force_full_wait_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">interval_charging;</span></span></code></pre></div><h3 id="_10-4-监控-soc-变化" tabindex="-1">10.4 监控 SOC 变化 <a class="header-anchor" href="#_10-4-监控-soc-变化" aria-label="Permalink to &quot;10.4 监控 SOC 变化&quot;">​</a></h3><p>在 battery_ui_capacity.c 中添加日志：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hwlog_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SOC Update: raw=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, scaled=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, filtered=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, vth_corrected=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, fake_filtered=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    raw_soc, scaled_soc, filtered_soc, vth_corrected_soc, final_soc);</span></span></code></pre></div><h3 id="_10-5-验证电压校正" tabindex="-1">10.5 验证电压校正 <a class="header-anchor" href="#_10-5-验证电压校正" aria-label="Permalink to &quot;10.5 验证电压校正&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dmesg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;correct capacity&quot;</span></span></code></pre></div><p>输出示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>bat_ui_capacity: correct capacity: bat_vol=3520,cap=12,lock_cap=15</span></span></code></pre></div><h3 id="_10-6-查看-dsm-告警" tabindex="-1">10.6 查看 DSM 告警 <a class="header-anchor" href="#_10-6-查看-dsm-告警" aria-label="Permalink to &quot;10.6 查看 DSM 告警&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dmesg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;soc vary fast&quot;</span></span></code></pre></div><p>输出示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>bat_ui_capacity: soc vary fast! soc_changed is -17</span></span>
<span class="line"><span>maxim_ds28e30, soc r_soc vol cur temp start:85,88,4100,-500,250 </span></span>
<span class="line"><span>end: 68,70,3900,-800,248 delta_soc=-17,soc_monitor_limit=15</span></span></code></pre></div><h3 id="_10-7-手动触发假电量过滤" tabindex="-1">10.7 手动触发假电量过滤 <a class="header-anchor" href="#_10-7-手动触发假电量过滤" aria-label="Permalink to &quot;10.7 手动触发假电量过滤&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 ECM 模式触发时</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">power_event_bnc_notify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POWER_BNT_LOW_POWER, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    POWER_NE_BAT_ECM_TRIGGER_STATUS, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ecm_status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><hr><h2 id="十一、关键宏定义" tabindex="-1">十一、关键宏定义 <a class="header-anchor" href="#十一、关键宏定义" aria-label="Permalink to &quot;十一、关键宏定义&quot;">​</a></h2><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_WINDOW_LEN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                      10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 滑动窗口长度</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_VBAT_MIN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                        3450</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 最低电压（mV）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_CAPACITY_FULL</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                   100</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // 满电电量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_SOC_JUMP_THRESHOLD</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // SOC 跳变阈值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_CURRENT_THRESHOLD</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">               10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 电流阈值（mA）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_LOWTEMP_THRESHOLD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 低温阈值（-5°C）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_WORK_INTERVAL_NORMAL</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            10000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 正常监控间隔（10s）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_WORK_INTERVAL_CHARGING</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          5000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 充电监控间隔（5s）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_CHG_FORCE_FULL_SOC_THRESHOLD</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    95</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 强制满电阈值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_CHG_FORCE_FULL_TIME</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">             24</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 强制满电时间（分钟）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_WAIT_MAX_TIME</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                   120000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 等待库仑计超时（120s）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_SOC_MONITOR_INTERVAL</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            60000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // SOC 监控间隔（60s）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_DEFAULT_SOC_MONITOR_LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       15</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // SOC 变化限制（15%）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_CAP_JUMP_TH</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                     7</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 开机电量跳变阈值（7%）</span></span></code></pre></div><hr><h2 id="十二、典型场景分析" tabindex="-1">十二、典型场景分析 <a class="header-anchor" href="#十二、典型场景分析" aria-label="Permalink to &quot;十二、典型场景分析&quot;">​</a></h2><h3 id="_12-1-场景-1-充电到-95-后长时间不变" tabindex="-1">12.1 场景 1：充电到 95% 后长时间不变 <a class="header-anchor" href="#_12-1-场景-1-充电到-95-后长时间不变" aria-label="Permalink to &quot;12.1 场景 1：充电到 95% 后长时间不变&quot;">​</a></h3><p><strong>现象：</strong> 用户反馈充电到 95% 后，24 分钟才跳到 100%。</p><p><strong>原因分析：</strong></p><ul><li>触发强制满电机制（<code>chg_force_full_soc_thld=95</code>）</li><li>默认等待时间：24 分钟</li></ul><p><strong>优化方案：</strong></p><div class="language-dts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>// 修改 DTS，缩短强制满电时间到 10 分钟</span></span>
<span class="line"><span>// chg_force_full_wait_time = 10 × 60 × 1000 / 5000 = 120 次</span></span></code></pre></div><p>或在代码中调整：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BUC_CHG_FORCE_FULL_TIME</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 改为 10 分钟</span></span></code></pre></div><h3 id="_12-2-场景-2-低电量时突然关机" tabindex="-1">12.2 场景 2：低电量时突然关机 <a class="header-anchor" href="#_12-2-场景-2-低电量时突然关机" aria-label="Permalink to &quot;12.2 场景 2：低电量时突然关机&quot;">​</a></h3><p><strong>现象：</strong> 电量显示 3% 时意外关机。</p><p><strong>原因分析：</strong></p><ul><li>库仑计 SOC 报 3%，但实际电压已低于关机阈值（3380mV）</li><li>关机电量校正功能可能未使能</li></ul><p><strong>解决方案：</strong></p><div class="language-dts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_ui_capacity {</span></span>
<span class="line"><span>    correct_shutdown_soc_en = &lt;1&gt;;  // 使能关机校正</span></span>
<span class="line"><span>    shutdown_cap = &lt;1&gt;;</span></span>
<span class="line"><span>    shutdown_gap = &lt;2&gt;;             // 在 [1%, 3%] 区间校正</span></span>
<span class="line"><span>    shutdown_vth = &lt;3380&gt;;</span></span>
<span class="line"><span>};</span></span></code></pre></div><h3 id="_12-3-场景-3-电量跳变异常" tabindex="-1">12.3 场景 3：电量跳变异常 <a class="header-anchor" href="#_12-3-场景-3-电量跳变异常" aria-label="Permalink to &quot;12.3 场景 3：电量跳变异常&quot;">​</a></h3><p><strong>现象：</strong> 电量从 85% 突然跳到 68%。</p><p><strong>调试步骤：</strong></p><ol><li>查看 DSM 日志：</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dmesg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;soc vary fast&quot;</span></span></code></pre></div><ol start="2"><li><p>分析跳变原因：</p><ul><li>电池老化导致内阻增大</li><li>温度变化导致 OCV 偏移</li><li>库仑计校准失败</li></ul></li><li><p>调整监控阈值（临时措施）：</p></li></ol><div class="language-dts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>soc_monitor_limit = &lt;20&gt;;  // 提高到 20%</span></span></code></pre></div><h3 id="_12-4-场景-4-硅基电池误识别" tabindex="-1">12.4 场景 4：硅基电池误识别 <a class="header-anchor" href="#_12-4-场景-4-硅基电池误识别" aria-label="Permalink to &quot;12.4 场景 4：硅基电池误识别&quot;">​</a></h3><p><strong>现象：</strong> 石墨电池被识别为硅基电池，电量始终显示 0%。</p><p><strong>原因分析：</strong></p><ul><li><code>bat_model_match_graphite_battery()</code> 返回 <code>false</code></li><li>触发假电量策略 0（BAT_FAKE_CAP_SRC_BAT_MODEL）</li></ul><p><strong>解决方案：</strong></p><p>检查电池型号识别逻辑：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// battery_model.c 中</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_match_graphite_battery</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 检查电池 ID、OCV 曲线等</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 返回 true 表示确定是石墨电池</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_12-5-场景-5-ecm-模式电量锁定" tabindex="-1">12.5 场景 5：ECM 模式电量锁定 <a class="header-anchor" href="#_12-5-场景-5-ecm-模式电量锁定" aria-label="Permalink to &quot;12.5 场景 5：ECM 模式电量锁定&quot;">​</a></h3><p><strong>现象：</strong> 进入 ECM（极低功耗）模式后，电量锁定在 1%。</p><p><strong>工作流程：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Low Power 模块检测到 ECM 触发</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>power_event_bnc_notify(POWER_BNT_LOW_POWER, </span></span>
<span class="line"><span>    POWER_NE_BAT_ECM_TRIGGER_STATUS, ECM_TRIGGER_CN)</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>bat_fake_cap_lpm_notifier_call()</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>g_bat_fake_cap_array[BAT_FAKE_CAP_SRC_ECM_MODE].policy_enable = ON</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>bat_fake_cap_filter(cap) → 若 cap ∈ [0,1]，锁定到 1%</span></span></code></pre></div><hr><h2 id="十三、总结" tabindex="-1">十三、总结 <a class="header-anchor" href="#十三、总结" aria-label="Permalink to &quot;十三、总结&quot;">​</a></h2><p><code>battery_ui_capacity</code> 模块通过<strong>多级过滤算法</strong>和<strong>智能状态机</strong>，将库仑计的原始 SOC 转换为用户友好的 UI 电量。核心亮点包括：</p><ol><li><strong>滑动窗口平滑：</strong> 10 点移动平均，消除瞬时波动</li><li><strong>充电状态感知：</strong> 充电/放电/满电下的不同处理逻辑</li><li><strong>电压二次校验：</strong> 通过 OCV 表防止虚电和意外关机</li><li><strong>假电量框架：</strong> 支持硅基电池检测、ECM 模式等特殊场景</li><li><strong>异常监控上报：</strong> DSM 机制及时发现 SOC 异常变化</li><li><strong>开机电量保护：</strong> 保存关机电量，避免重启跳变</li><li><strong>温度自适应：</strong> 低温下提高监控频率，确保准确性</li></ol><p>该模块是华为电池管理系统的核心组件，直接影响用户电量显示体验和关机保护可靠性，广泛应用于旗舰手机、平板和折叠屏设备中。</p>`,177)])])}const E=a(p,[["render",l]]);export{g as __pageData,E as default};
