import{_ as i,c as a,o as t,a0 as n}from"./chunks/framework.Cee10E_e.js";const c=JSON.parse('{"title":"华为电池核心之battery_1s2p模块","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"hw_charging/business/battery-core/battery_1s2p.md","filePath":"hw_charging/business/battery-core/battery_1s2p.md"}'),l={name:"hw_charging/business/battery-core/battery_1s2p.md"};function e(p,s,h,k,d,r){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="华为电池核心之battery-1s2p模块" tabindex="-1">华为电池核心之battery_1s2p模块 <a class="header-anchor" href="#华为电池核心之battery-1s2p模块" aria-label="Permalink to &quot;华为电池核心之battery_1s2p模块&quot;">​</a></h1><h2 id="一、模块概述" tabindex="-1">一、模块概述 <a class="header-anchor" href="#一、模块概述" aria-label="Permalink to &quot;一、模块概述&quot;">​</a></h2><p>battery_1s2p 是华为电源管理子系统中的<strong>双电池并联管理驱动</strong>，专门用于处理 <strong>1S2P（1串2并）电池配置</strong>场景。该模块实现了双电池的智能融合算法，通过加权计算提供统一的 SOC、电压、电流等参数，对外呈现为单一电池系统。</p><p><strong>核心功能：</strong></p><ul><li>双电池独立监控（主电池 BAT_MAIN + 辅助电池 BAT_AUX）</li><li>基于电压阈值的动态加权 SOC 融合算法</li><li>容量比例配置与管理</li><li>双电池差异检测与故障报告（DSM/DMD）</li><li>自适应监控间隔调整</li><li>统一 coul_interface_ops 接口实现</li></ul><hr><h2 id="二、主要数据结构" tabindex="-1">二、主要数据结构 <a class="header-anchor" href="#二、主要数据结构" aria-label="Permalink to &quot;二、主要数据结构&quot;">​</a></h2><h3 id="_2-1-每电池信息结构体-battery-info" tabindex="-1">2.1 每电池信息结构体 <code>battery_info</code> <a class="header-anchor" href="#_2-1-每电池信息结构体-battery-info" aria-label="Permalink to &quot;2.1 每电池信息结构体 \`battery_info\`&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> battery_info {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> soc;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                          // 电池SOC（%）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> last_soc;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     // 上次记录的SOC</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> volt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                         // 电池电压（mV）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cur;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                          // 电池电流（mA）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cap_ratio;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           // 容量占比（50% = CAP_RATIO_MAX / 2）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> weight_chg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[WEIGHT_FACTOR_COUNT];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 充电权重因子数组（3个）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> weight_dischg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[WEIGHT_FACTOR_COUNT];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 放电权重因子数组（3个）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> volt_low;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 低电压阈值（mV）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p><strong>说明：</strong></p><ul><li><code>cap_ratio</code>: 该电池在总容量中的占比（默认 50%，即两电池容量相同）</li><li><code>weight_chg/weight_dischg</code>: 三段式权重因子，对应不同电压区间： <ul><li><code>[0]</code>: 电压 &lt; volt_low 时的权重</li><li><code>[1]</code>: volt_low ≤ 电压 &lt; VOLT_HIGH_THRESHOLD 时的权重</li><li><code>[2]</code>: 电压 ≥ VOLT_HIGH_THRESHOLD 时的权重</li></ul></li></ul><h3 id="_2-2-主设备结构体-bat-1s2p-device" tabindex="-1">2.2 主设备结构体 <code>bat_1s2p_device</code> <a class="header-anchor" href="#_2-2-主设备结构体-bat-1s2p-device" aria-label="Permalink to &quot;2.2 主设备结构体 \`bat_1s2p_device\`&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_1s2p_device {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> power_wakeup_source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wakelock;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delayed_work monitor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mutex lock;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> battery_info </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bat_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_TOTAL];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 双电池信息数组</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> interval;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 监控周期（ms）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cap_diff_thr;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // 容量差异阈值（%）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vol_type;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                             // 电压查询类型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cycle_type;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                           // 循环次数查询类型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> last_cap_type;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                        // 最后容量查询类型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> temp_type;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                            // 温度查询类型</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><hr><h2 id="三、核心算法" tabindex="-1">三、核心算法 <a class="header-anchor" href="#三、核心算法" aria-label="Permalink to &quot;三、核心算法&quot;">​</a></h2><h3 id="_1-加权-soc-融合算法-bat-1s2p-get-mix-soc" tabindex="-1">1. 加权 SOC 融合算法 <code>bat_1s2p_get_mix_soc()</code> <a class="header-anchor" href="#_1-加权-soc-融合算法-bat-1s2p-get-mix-soc" aria-label="Permalink to &quot;1. 加权 SOC 融合算法 \`bat_1s2p_get_mix_soc()\`&quot;">​</a></h3><p><strong>算法流程：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">混合SOC </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (主电池SOC × 主电池权重 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 辅助电池SOC × 辅助电池权重) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (主电池权重 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 辅助电池权重)</span></span></code></pre></div><p><strong>权重选择逻辑：</strong></p><table tabindex="0"><thead><tr><th>电压区间</th><th>权重数组索引</th><th>说明</th></tr></thead><tbody><tr><td>电压 &lt; volt_low</td><td><code>weight_xxx[0]</code></td><td>低电压区，电池特性差异大</td></tr><tr><td>volt_low ≤ 电压 &lt; VOLT_HIGH_THRESHOLD (4200mV)</td><td><code>weight_xxx[1]</code></td><td>中等电压区</td></tr><tr><td>电压 ≥ VOLT_HIGH_THRESHOLD</td><td><code>weight_xxx[2]</code></td><td>高电压区，接近满电</td></tr></tbody></table><p><strong>充放电状态判断：</strong></p><ul><li>充电状态：优先使用 <code>weight_chg</code> 数组</li><li>放电状态：优先使用 <code>weight_dischg</code> 数组</li></ul><p><strong>示例权重配置（DTS）：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>weight_factor_chg_0 = &lt;20 50 80&gt;;    // 主电池充电权重（低/中/高）</span></span>
<span class="line"><span>weight_factor_dischg_0 = &lt;30 50 70&gt;; // 主电池放电权重</span></span>
<span class="line"><span>weight_factor_chg_1 = &lt;80 50 20&gt;;    // 辅助电池充电权重</span></span>
<span class="line"><span>weight_factor_dischg_1 = &lt;70 50 30&gt;; // 辅助电池放电权重</span></span></code></pre></div><h3 id="_2-监控间隔自适应算法-bat-1s2p-select-work-interval" tabindex="-1">2. 监控间隔自适应算法 <code>bat_1s2p_select_work_interval()</code> <a class="header-anchor" href="#_2-监控间隔自适应算法-bat-1s2p-select-work-interval" aria-label="Permalink to &quot;2. 监控间隔自适应算法 \`bat_1s2p_select_work_interval()\`&quot;">​</a></h3><table tabindex="0"><thead><tr><th>SOC 范围</th><th>监控间隔</th></tr></thead><tbody><tr><td>SOC &lt; 10%</td><td>10 秒</td></tr><tr><td>10% ≤ SOC &lt; 90%</td><td>60 秒</td></tr><tr><td>SOC ≥ 90%</td><td>10 秒</td></tr></tbody></table><p><strong>设计理念：</strong> 在电量极低/极高时提高监控频率，确保准确捕捉关键状态变化。</p><h3 id="_3-故障检测算法-bat-1s2p-detect-fault-send-dmd" tabindex="-1">3. 故障检测算法 <code>bat_1s2p_detect_fault_send_dmd()</code> <a class="header-anchor" href="#_3-故障检测算法-bat-1s2p-detect-fault-send-dmd" aria-label="Permalink to &quot;3. 故障检测算法 \`bat_1s2p_detect_fault_send_dmd()\`&quot;">​</a></h3><p><strong>检测项：</strong></p><ol><li><strong>电池缺失检测：</strong> 任一电池 SOC ≤ 0% 时判定为缺失</li><li><strong>容量差异检测：</strong> <code>|主电池SOC - 辅助电池SOC| &gt; cap_diff_thr</code> 时触发告警</li></ol><p><strong>DMD 上报：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">power_dsm_report_dmd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POWER_DSM_BATTERY, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ERROR_BATT_TEMP_CCAL_DIFF_OVH, </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;battery_1s2p: battery</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> missing&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 电池缺失</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">power_dsm_report_dmd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POWER_DSM_BATTERY,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ERROR_BATT_TEMP_CCAL_DIFF_OVH,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;capacity_diff=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d%%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 容量差异</span></span></code></pre></div><hr><h2 id="四、coul-interface-ops-接口实现" tabindex="-1">四、coul_interface_ops 接口实现 <a class="header-anchor" href="#四、coul-interface-ops-接口实现" aria-label="Permalink to &quot;四、coul_interface_ops 接口实现&quot;">​</a></h2><h3 id="核心接口映射表" tabindex="-1">核心接口映射表 <a class="header-anchor" href="#核心接口映射表" aria-label="Permalink to &quot;核心接口映射表&quot;">​</a></h3><table tabindex="0"><thead><tr><th>接口函数</th><th>实现策略</th><th>说明</th></tr></thead><tbody><tr><td><code>read_battery_soc</code></td><td>加权融合</td><td>调用 <code>bat_1s2p_get_mix_soc()</code></td></tr><tr><td><code>read_battery_vol</code></td><td>按 vol_type 选择</td><td>主电池/辅助电池/最大/最小/平均</td></tr><tr><td><code>read_battery_current</code></td><td>求和</td><td>主电池电流 + 辅助电池电流</td></tr><tr><td><code>read_battery_fcc</code></td><td>按容量比加权</td><td><code>主电池FCC × 主电池占比 + 辅助电池FCC × 辅助电池占比</code></td></tr><tr><td><code>read_battery_cycle</code></td><td>按 cycle_type 选择</td><td>主电池/辅助电池/最大/最小/平均</td></tr><tr><td><code>get_battery_temperature</code></td><td>调用 battery_temp 接口</td><td><code>bat_temp_get_temperature(temp_type)</code></td></tr></tbody></table><h3 id="vol-type-电压查询类型" tabindex="-1">vol_type 电压查询类型 <a class="header-anchor" href="#vol-type-电压查询类型" aria-label="Permalink to &quot;vol_type 电压查询类型&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BAT_VOL_MAIN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 查询主电池电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BAT_VOL_AUX</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 查询辅助电池电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BAT_VOL_MAX</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 查询最大电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BAT_VOL_MIN</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 查询最小电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BAT_VOL_AVG</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 查询平均电压</span></span></code></pre></div><hr><h2 id="五、dts-配置" tabindex="-1">五、DTS 配置 <a class="header-anchor" href="#五、dts-配置" aria-label="Permalink to &quot;五、DTS 配置&quot;">​</a></h2><h3 id="配置示例" tabindex="-1">配置示例 <a class="header-anchor" href="#配置示例" aria-label="Permalink to &quot;配置示例&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_1s2p {</span></span>
<span class="line"><span>    compatible = &quot;huawei,battery_1s2p&quot;;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 全局配置 */</span></span>
<span class="line"><span>    vol_type = &lt;4&gt;;          // 使用平均电压</span></span>
<span class="line"><span>    cycle_type = &lt;2&gt;;        // 使用最大循环次数</span></span>
<span class="line"><span>    last_cap_type = &lt;0&gt;;     // 使用主电池最后容量</span></span>
<span class="line"><span>    temp_type = &lt;0&gt;;         // 温度类型（传递给 battery_temp）</span></span>
<span class="line"><span>    cap_diff_thr = &lt;10&gt;;     // 容量差异阈值 10%</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 主电池（BAT_MAIN）配置 */</span></span>
<span class="line"><span>    cap_ratio_0 = &lt;50&gt;;      // 容量占比 50%</span></span>
<span class="line"><span>    weight_factor_chg_0 = &lt;30 50 70&gt;;     // 充电权重</span></span>
<span class="line"><span>    weight_factor_dischg_0 = &lt;40 50 60&gt;;  // 放电权重</span></span>
<span class="line"><span>    volt_low_0 = &lt;3400&gt;;     // 低电压阈值 3400mV</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 辅助电池（BAT_AUX）配置 */</span></span>
<span class="line"><span>    cap_ratio_1 = &lt;50&gt;;</span></span>
<span class="line"><span>    weight_factor_chg_1 = &lt;70 50 30&gt;;</span></span>
<span class="line"><span>    weight_factor_dischg_1 = &lt;60 50 40&gt;;</span></span>
<span class="line"><span>    volt_low_1 = &lt;3400&gt;;</span></span>
<span class="line"><span>};</span></span></code></pre></div><h3 id="参数说明" tabindex="-1">参数说明 <a class="header-anchor" href="#参数说明" aria-label="Permalink to &quot;参数说明&quot;">​</a></h3><table tabindex="0"><thead><tr><th>DTS 属性</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>cap_ratio_X</code></td><td>u32</td><td>50</td><td>第 X 个电池容量占比（0-100）</td></tr><tr><td><code>weight_factor_chg_X</code></td><td>u32[3]</td><td>无</td><td>充电权重因子数组（必须配置）</td></tr><tr><td><code>weight_factor_dischg_X</code></td><td>u32[3]</td><td>无</td><td>放电权重因子数组（必须配置）</td></tr><tr><td><code>volt_low</code></td><td>u32</td><td>3500mV</td><td>低电压阈值</td></tr><tr><td><code>cap_diff_thr</code></td><td>u32</td><td>5%</td><td>容量差异告警阈值</td></tr></tbody></table><hr><h2 id="六、监控机制" tabindex="-1">六、监控机制 <a class="header-anchor" href="#六、监控机制" aria-label="Permalink to &quot;六、监控机制&quot;">​</a></h2><h3 id="_6-1-工作队列-bat-1s2p-monitor-work" tabindex="-1">6.1 工作队列 <code>bat_1s2p_monitor_work()</code> <a class="header-anchor" href="#_6-1-工作队列-bat-1s2p-monitor-work" aria-label="Permalink to &quot;6.1 工作队列 \`bat_1s2p_monitor_work()\`&quot;">​</a></h3><p><strong>执行流程：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────┐</span></span>
<span class="line"><span>│ 1. 获取 wakelock         │</span></span>
<span class="line"><span>├─────────────────────────┤</span></span>
<span class="line"><span>│ 2. 更新双电池信息        │</span></span>
<span class="line"><span>│    - bat_1s2p_update_bat_info() │</span></span>
<span class="line"><span>├─────────────────────────┤</span></span>
<span class="line"><span>│ 3. SOC 平滑处理          │</span></span>
<span class="line"><span>│    - bat_1s2p_smooth_soc() │</span></span>
<span class="line"><span>├─────────────────────────┤</span></span>
<span class="line"><span>│ 4. 故障检测与 DMD 上报   │</span></span>
<span class="line"><span>│    - bat_1s2p_detect_fault_send_dmd() │</span></span>
<span class="line"><span>├─────────────────────────┤</span></span>
<span class="line"><span>│ 5. 调整监控间隔          │</span></span>
<span class="line"><span>│    - bat_1s2p_select_work_interval() │</span></span>
<span class="line"><span>├─────────────────────────┤</span></span>
<span class="line"><span>│ 6. 释放 wakelock         │</span></span>
<span class="line"><span>├─────────────────────────┤</span></span>
<span class="line"><span>│ 7. 重新调度工作队列      │</span></span>
<span class="line"><span>└─────────────────────────┘</span></span></code></pre></div><h3 id="_6-2-soc-平滑算法" tabindex="-1">6.2 SOC 平滑算法 <a class="header-anchor" href="#_6-2-soc-平滑算法" aria-label="Permalink to &quot;6.2 SOC 平滑算法&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">abs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bat_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].soc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bat_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].last_soc) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // SOC 变化 ±1% 时不更新，避免频繁跳变</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    di-&gt;bat_info[i].soc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di-&gt;bat_info[i].last_soc;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bat_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].last_soc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bat_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i].soc;</span></span></code></pre></div><hr><h2 id="七、驱动生命周期" tabindex="-1">七、驱动生命周期 <a class="header-anchor" href="#七、驱动生命周期" aria-label="Permalink to &quot;七、驱动生命周期&quot;">​</a></h2><h3 id="_7-1-初始化流程-bat-1s2p-probe" tabindex="-1">7.1 初始化流程 <code>bat_1s2p_probe()</code> <a class="header-anchor" href="#_7-1-初始化流程-bat-1s2p-probe" aria-label="Permalink to &quot;7.1 初始化流程 \`bat_1s2p_probe()\`&quot;">​</a></h3><ol><li><strong>内存分配：</strong> <code>devm_kzalloc()</code> 分配设备结构体</li><li><strong>DTS 解析：</strong> <code>bat_1s2p_parse_dts()</code> 读取配置参数</li><li><strong>资源初始化：</strong><ul><li>注册 wakelock（防止休眠期间异常）</li><li>初始化互斥锁 <code>mutex_init()</code></li><li>初始化延迟工作队列 <code>INIT_DELAYED_WORK()</code></li></ul></li><li><strong>双电池信息初始化：</strong> <code>bat_1s2p_init_info()</code></li><li><strong>启动监控：</strong> 调度第一次工作队列</li><li><strong>注册 coul 接口：</strong> <code>coul_interface_ops_register(&amp;g_1s2p_ops)</code></li></ol><h3 id="_7-2-电源管理" tabindex="-1">7.2 电源管理 <a class="header-anchor" href="#_7-2-电源管理" aria-label="Permalink to &quot;7.2 电源管理&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_1s2p_suspend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():  取消延迟工作队列（省电）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_1s2p_resume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():   立即调度工作队列（快速恢复监控）</span></span></code></pre></div><h3 id="_7-3-模块加载优先级" tabindex="-1">7.3 模块加载优先级 <a class="header-anchor" href="#_7-3-模块加载优先级" aria-label="Permalink to &quot;7.3 模块加载优先级&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#ifdef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CONFIG_COUL_DRV</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rootfs_initcall</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bat_1s2p_init);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 依赖 coul 驱动时使用 rootfs 阶段</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#else</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">device_initcall_sync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bat_1s2p_init);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 否则使用 device 阶段</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#endif</span></span></code></pre></div><hr><h2 id="八、调试技巧" tabindex="-1">八、调试技巧 <a class="header-anchor" href="#八、调试技巧" aria-label="Permalink to &quot;八、调试技巧&quot;">​</a></h2><h3 id="_8-1-查看实时混合-soc" tabindex="-1">8.1 查看实时混合 SOC <a class="header-anchor" href="#_8-1-查看实时混合-soc" aria-label="Permalink to &quot;8.1 查看实时混合 SOC&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/class/power_supply/Battery/capacity</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 通过 coul_interface 获取的混合 SOC</span></span></code></pre></div><h3 id="_8-2-动态调整监控间隔测试" tabindex="-1">8.2 动态调整监控间隔测试 <a class="header-anchor" href="#_8-2-动态调整监控间隔测试" aria-label="Permalink to &quot;8.2 动态调整监控间隔测试&quot;">​</a></h3><p>修改 battery_1s2p.c 中的阈值：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 原代码</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (soc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> soc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 90</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">interval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_1S2P_WORK_INTERVAL_FAST;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 调试代码（全时段快速监控）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">interval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_1S2P_WORK_INTERVAL_FAST;</span></span></code></pre></div><h3 id="_8-3-监控-dmd-告警" tabindex="-1">8.3 监控 DMD 告警 <a class="header-anchor" href="#_8-3-监控-dmd-告警" aria-label="Permalink to &quot;8.3 监控 DMD 告警&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dmesg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;battery_1s2p&quot;</span></span></code></pre></div><p>常见日志：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_1s2p: battery0 missing  # 主电池缺失</span></span>
<span class="line"><span>battery_1s2p: battery1 missing  # 辅助电池缺失</span></span>
<span class="line"><span>battery_1s2p: capacity_diff=15% # 容量差异超过阈值</span></span></code></pre></div><h3 id="_8-4-验证加权算法" tabindex="-1">8.4 验证加权算法 <a class="header-anchor" href="#_8-4-验证加权算法" aria-label="Permalink to &quot;8.4 验证加权算法&quot;">​</a></h3><p>在 battery_1s2p.c 末尾添加日志：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hwlog_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mix_soc=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> (main:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">×</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> + aux:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">×</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">) / </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%u\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mix_soc,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bat_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_MAIN].soc, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">weight</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_MAIN],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bat_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_AUX].soc, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">weight</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_AUX],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    weight</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_MAIN] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> weight</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_AUX]);</span></span></code></pre></div><hr><h2 id="九、关键宏定义" tabindex="-1">九、关键宏定义 <a class="header-anchor" href="#九、关键宏定义" aria-label="Permalink to &quot;九、关键宏定义&quot;">​</a></h2><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BAT_1S2P_WORK_INTERVAL_FAST</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 快速监控间隔（10秒）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BAT_1S2P_WORK_INTERVAL_SLOW</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   60000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 慢速监控间隔（60秒）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VOLT_HIGH_THRESHOLD</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">           4200</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 高电压阈值（mV）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VOLT_LOW_THRESHOLD</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            3500</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 低电压阈值（mV）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CAP_RATIO_MAX</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                 100</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 容量比例最大值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> WEIGHT_FACTOR_COUNT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">           3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 权重因子数量</span></span></code></pre></div><hr><h2 id="十、总结" tabindex="-1">十、总结 <a class="header-anchor" href="#十、总结" aria-label="Permalink to &quot;十、总结&quot;">​</a></h2><p>battery_1s2p.c 通过<strong>多维度加权融合算法</strong>将双电池系统抽象为单一电池，核心亮点包括：</p><ol><li><strong>自适应权重机制：</strong> 根据电压区间和充放电状态动态调整融合权重</li><li><strong>智能监控策略：</strong> 在关键 SOC 区间提高监控频率，平衡性能与功耗</li><li><strong>容错设计：</strong> 通过 DMD 机制及时发现电池缺失或异常差异</li><li><strong>灵活配置：</strong> 支持 DTS 动态配置容量比例、权重因子等参数</li></ol><p>该模块是华为折叠屏等多电池设备的核心电源管理组件，确保了双电池系统的可靠性和用户体验一致性。</p>`,81)])])}const g=i(l,[["render",e]]);export{c as __pageData,g as default};
