import{c as a,o as n,a0 as t,j as i,a as l,k as p}from"./chunks/framework.Cee10E_e.js";const h="/assets/UML_battery_core.Ciy7GV8w.svg",k="/assets/UML_battery_core.Ciy7GV8w.svg",e=["href"],c=JSON.parse('{"title":"华为充电管理之电池核心","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"hw_charging/business/battery-core/overview.md","filePath":"hw_charging/business/battery-core/overview.md"}'),E={name:"hw_charging/business/battery-core/overview.md"},y=Object.assign(E,{setup(r){return(d,s)=>(n(),a("div",null,[s[1]||(s[1]=t(`<h1 id="华为充电管理之电池核心" tabindex="-1">华为充电管理之电池核心 <a class="header-anchor" href="#华为充电管理之电池核心" aria-label="Permalink to &quot;华为充电管理之电池核心&quot;">​</a></h1><p>battery_core.c 是华为电源管理框架的电池核心驱动，负责：</p><ul><li>电池状态监控与数据采集</li><li>Power Supply 框架接口实现</li><li>电池健康度管理</li><li>UI 电量显示控制</li></ul><h2 id="一、核心数据结构" tabindex="-1">一、核心数据结构 <a class="header-anchor" href="#一、核心数据结构" aria-label="Permalink to &quot;一、核心数据结构&quot;">​</a></h2><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 电量等级描述结构</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 用于根据 UI 电量(capacity) 映射成离散的电量等级 level</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 常用于策略判断（如不同 SOC 档位采取不同策略）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_capacity_level {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> min_cap;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* 该等级适用的最小电量百分比（包含） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max_cap;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* 该等级适用的最大电量百分比（包含） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> level;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     /* 电量等级值（由 DTS/策略定义的抽象等级） */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * battery_core 监控周期参数</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 根据当前电量区间，动态调整 battery_core monitor work 的刷新周期</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_monitor_para {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> min_cap;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* 该参数生效的最小电量百分比 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> max_cap;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* 该参数生效的最大电量百分比 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> interval;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* 对应的 monitor work 调度周期（单位：ms） */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * battery_core 配置结构</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 主要来自 device tree（DTS），用于描述电池/库仑计/温度相关参数</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_config {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voltage_now_scale;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* 电池瞬时电压缩放系数（用于 raw 数据转 mV） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voltage_max_scale;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* 最大充电电压缩放系数（用于 vterm 计算） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> charge_fcc_scale;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* FCC（满充容量）缩放系数 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> charge_rm_scale;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     /* RM（剩余容量）缩放系数 */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> coul_type;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           /* 库仑计类型：主库仑计 / 辅助库仑计（COUL_TYPE_xxx） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> temp_type;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           /* 温度来源类型（直读库仑计 / 混合温度源等） */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> work_para_cols;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* 实际生效的监控参数行数（work_para 数组有效项数） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ntc_compensation_is;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* 是否启用 NTC 温度补偿（0：关闭，1：开启） */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* 根据电量区间配置的 monitor work 周期参数表 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_monitor_para </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">work_para</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_CORE_WORK_PARA_ROW];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/* NTC 温度补偿参数表（按电流/温区分档） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compensation_para </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">temp_comp_para</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_CORE_NTC_PARA_LEVEL];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * battery_core 运行时数据缓存</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 由 monitor work 周期性刷新，并通过 power_supply / ops 对外提供</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_data {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exist;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             /* 电池是否在位（1：存在，0：不存在） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> charge_status;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     /* 当前充电状态（POWER_SUPPLY_STATUS_xxx） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> health;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            /* 电池健康状态（POWER_SUPPLY_HEALTH_xxx） */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ui_capacity;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       /* UI 显示的电量百分比（0~100） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> capacity_level;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 当前电量等级（由 capacity_level 表映射） */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> temp_now;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          /* 当前电池温度（单位：0.1°C 或 m°C，视实现而定） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cycle_count;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       /* 电池循环次数 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fcc;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               /* 电池满充容量 FCC（已按 scale 处理） */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> voltage_max_now;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* 当前允许的最大充电电压（动态可调） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> capacity_rm;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       /* 剩余容量 RM（已按 scale 处理） */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * battery_core 设备实例</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 作为整个 battery_core 驱动的核心上下文</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_device {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                 /* 对应的 platform device */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> power_supply </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">main_psy;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* 主电池 power_supply 设备（battery_gauge） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> power_supply </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">aux_psy;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       /* 辅助电池 power_supply 设备（battery_gauge_aux） */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> work_interval;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  /* 当前 monitor work 的调度周期（ms） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delayed_work monitor_work;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* 周期性刷新电池数据的 work */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wakeup_source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wakelock;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     /* 防止 monitor 执行过程中系统休眠的 wakelock */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mutex data_lock;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             /* 保护 bat_core_data 的互斥锁 */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> notifier_block event_nb;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     /* 充电/电源事件通知回调 */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_config config;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* DTS 解析得到的配置参数 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_data data;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          /* 当前电池状态的数据缓存 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>驱动核心对象是 struct bat_core_device *di（全局 <code>g_bat_core_dev</code> 也会保存一份）。</p><h2 id="二、关键功能模块" tabindex="-1">二、关键功能模块 <a class="header-anchor" href="#二、关键功能模块" aria-label="Permalink to &quot;二、关键功能模块&quot;">​</a></h2><h3 id="_2-1-power-supply属性接口" tabindex="-1">2.1 Power supply属性接口 <a class="header-anchor" href="#_2-1-power-supply属性接口" aria-label="Permalink to &quot;2.1 Power supply属性接口&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> enum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> power_supply_property bat_core_props</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    POWER_SUPPLY_PROP_PRESENT,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 电池存在</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    POWER_SUPPLY_PROP_ONLINE,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 在线状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    POWER_SUPPLY_PROP_TEMP,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 温度</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    POWER_SUPPLY_PROP_CYCLE_COUNT,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 循环次数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    POWER_SUPPLY_PROP_VOLTAGE_NOW,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 电压</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    POWER_SUPPLY_PROP_CURRENT_NOW,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 电流</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    POWER_SUPPLY_PROP_CAPACITY,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // 电量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    POWER_SUPPLY_PROP_CHARGE_FULL,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 满充容量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>属性获取函数： <code>bat_core_get_prop()</code>: 根据 coul_type (主/辅电池) 从库仑计读取数据 支持双电池系统 (COUL_TYPE_MAIN / COUL_TYPE_AUX)</p><h3 id="_2-2电池状态管理" tabindex="-1">2.2电池状态管理 <a class="header-anchor" href="#_2-2电池状态管理" aria-label="Permalink to &quot;2.2电池状态管理&quot;">​</a></h3><p>核心 getter 函数：</p><table tabindex="0"><thead><tr><th style="text-align:center;">函数</th><th style="text-align:left;">功能</th><th style="text-align:left;">数据来源</th></tr></thead><tbody><tr><td style="text-align:center;">bat_core_get_status()</td><td style="text-align:left;">充电状态</td><td style="text-align:left;">di-&gt;data.charge_status</td></tr><tr><td style="text-align:center;">bat_core_get_health()</td><td style="text-align:left;">健康状态</td><td style="text-align:left;">di-&gt;data.health</td></tr><tr><td style="text-align:center;">bat_core_get_temp()</td><td style="text-align:left;">电池温度</td><td style="text-align:left;">bat_core_temp()</td></tr><tr><td style="text-align:center;">bat_core_get_voltage_now()</td><td style="text-align:left;">实时电压</td><td style="text-align:left;">coul_interface</td></tr><tr><td style="text-align:center;">bat_core_get_ui_capacity()</td><td style="text-align:left;">UI 电量</td><td style="text-align:left;">bat_ui_capacity()</td></tr></tbody></table><p>电量等级映射</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>// UI 电量 → 电量等级转换</span></span>
<span class="line"><span>0-5%    → CRITICAL (危险)</span></span>
<span class="line"><span>5-15%   → LOW (低)</span></span>
<span class="line"><span>15-95%  → NORMAL (正常)</span></span>
<span class="line"><span>95-100% → HIGH (高)</span></span>
<span class="line"><span>100%    → FULL (满)</span></span></code></pre></div><h3 id="_2-3定期监控机制" tabindex="-1">2.3定期监控机制 <a class="header-anchor" href="#_2-3定期监控机制" aria-label="Permalink to &quot;2.3定期监控机制&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_core_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> work_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 获取唤醒锁，防止系统休眠</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      __pm_wakeup_event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di-&gt;wakelock, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jiffies_to_msecs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(HZ));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 核心数据更新</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      bat_core_update_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 动态调整监控间隔</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      bat_core_update_work_interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 重新调度下一次执行</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      queue_delayed_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(system_freezable_power_efficient_wq, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di-&gt;monitor_work,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          msecs_to_jiffies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di-&gt;work_interval));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><p><strong>动态监控策略：</strong> bat_core_update_work_interval(di) 让监控刷新频率随电量变化：</p><ul><li>如果 health unknown：直接用 <code>BAT_CORE_WORK_INTERVAL_ABNORMAL</code></li><li>如果 DTS 没配 work_interval_para：用默认 <code>BAT_CORE_WORK_INTERVAL_NORMAL</code></li><li>否则读取 work_interval_para（min_cap、max_cap、interval），匹配当前 ui_capacity，选择对应 interval</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>// DTS 配置示例</span></span>
<span class="line"><span>work_interval_para = &lt;</span></span>
<span class="line"><span>    0  20  5000    // 0-20%: 5秒</span></span>
<span class="line"><span>    20 80  10000   // 20-80%: 10秒</span></span>
<span class="line"><span>    80 100 5000    // 80-100%: 5秒</span></span>
<span class="line"><span>&gt;;</span></span></code></pre></div><p>这个动态监控测率</p><ul><li>根据电量区间动态调整监控频率</li><li>低电量时缩短间隔 (快速响应)</li><li>正常电量可延长间隔 (省电)</li></ul><blockquote><p>低电/异常状态更频繁刷新，高电/稳定状态降低刷新频率省电。</p></blockquote><h3 id="_2-4-温度补偿算法" tabindex="-1">2.4 温度补偿算法 <a class="header-anchor" href="#_2-4-温度补偿算法" aria-label="Permalink to &quot;2.4 温度补偿算法&quot;">​</a></h3><h4 id="_2-4-1-温度读取入口" tabindex="-1">2.4.1 温度读取入口 <a class="header-anchor" href="#_2-4-1-温度读取入口" aria-label="Permalink to &quot;2.4.1 温度读取入口&quot;">​</a></h4><p><code>bat_core_temp(di)</code> 是统一入口：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_core_temp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">di</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (temp_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_CORE_TEMP_TYPE_MIXED) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 混合温度 (多温度源融合)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        bat_temp_get_temperature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(BAT_TEMP_MIXED, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">raw_temp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 库仑计温度 + NTC 补偿</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        raw_temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> coul_interface_get_battery_temperature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        raw_temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_core_ntc_compensation_temp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di, raw_temp, bat_curr);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>如果 temp_type == BAT_CORE_TEMP_TYPE_MIXED，用 bat_temp_get_temperature(BAT_TEMP_MIXED, &amp;raw_temp)（可能是多源融合后的温度）</li><li>否则： <ul><li>raw_temp = coul_interface_get_battery_temperature(...)</li><li>bat_curr = coul_interface_get_battery_current(...)</li><li>再走 bat_core_ntc_compensation_temp() 做 NTC 补偿</li></ul></li></ul><h4 id="_2-4-2-ntc-补偿参数来自-dts" tabindex="-1">2.4.2 NTC 补偿参数来自 DTS <a class="header-anchor" href="#_2-4-2-ntc-补偿参数来自-dts" aria-label="Permalink to &quot;2.4.2 NTC 补偿参数来自 DTS&quot;">​</a></h4><p><code>bat_core_parse_temp_para()</code> 从 device tree 读取：</p><ul><li>temp_type</li><li>ntc_compensation_is（是否启用补偿）</li><li>ntc_temp_compensation_para（补偿表：参考电流 refer + 补偿值 comp_value 等）</li></ul><p>补偿逻辑里会根据当前电流（abs(cur_temp)）查表/计算，最终输出补偿后的温度，并打印：</p><blockquote><p>temp_compensation=... temp_no_comp=... ichg=...</p></blockquote><ul><li>防止大电流充电时温升影响温度读数</li><li>补偿参数通过 DTS 配置</li></ul><h3 id="_2-5-健康度的判定" tabindex="-1">2.5 健康度的判定 <a class="header-anchor" href="#_2-5-健康度的判定" aria-label="Permalink to &quot;2.5 健康度的判定&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_core_update_health</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">di</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di-&gt;data.exist) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_HEALTH_UNKNOWN;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (temp_now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_CORE_TEMP_UNKNOWN) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_HEALTH_UNKNOWN;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_fault_is_cutoff_vol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_HEALTH_UNDERVOLTAGE;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 欠压</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        bat_fault_send_under_voltage_event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (temp_now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_CORE_COLD_TEMP) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_HEALTH_COLD;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 低温</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (temp_now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_CORE_OVERHEAT_TEMP) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_HEALTH_OVERHEAT;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 过热</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        health </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_HEALTH_GOOD;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 正常</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>bat_core_update_health(di)</code> 负责把 di-&gt;data.health 更新为标准 power_supply health： 判定顺序大致是：</p><ul><li>电池不在位：HEALTH_UNKNOWN</li><li>温度未知：HEALTH_UNKNOWN</li><li>如果 bat_fault_is_cutoff_vol()：HEALTH_UNDERVOLTAGE，并触发 bat_fault_send_under_voltage_event()</li><li>温度过低 &lt; BAT_CORE_COLD_TEMP：HEALTH_COLD</li><li>温度过高 &gt; BAT_CORE_OVERHEAT_TEMP：HEALTH_OVERHEAT</li><li>否则：HEALTH_GOOD</li></ul><p>并且只在变化时打印 “health change from x to y”。</p><h3 id="_2-6-充电状态更新" tabindex="-1">2.6 充电状态更新 <a class="header-anchor" href="#_2-6-充电状态更新" aria-label="Permalink to &quot;2.6 充电状态更新&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_core_update_charge_status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">di</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 特殊处理：充电中 + 电量满 → 充满状态</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_STATUS_CHARGING) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        (di-&gt;data.ui_capacity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_CORE_CAPACITY_FULL)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        cur_status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_STATUS_FULL;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 状态变化时同步通知 Android 层</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (di-&gt;data.charge_status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cur_status) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        di-&gt;data.charge_status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cur_status;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_supply_sync_changed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Battery&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 大写 B</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_supply_sync_changed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;battery&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 小写 b</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2-7-事件驱动的状态更新" tabindex="-1">2.7 事件驱动的状态更新 <a class="header-anchor" href="#_2-7-事件驱动的状态更新" aria-label="Permalink to &quot;2.7 事件驱动的状态更新&quot;">​</a></h3><p>驱动会注册一个事件通知： <code>power_event_bnc_register(POWER_BNT_CHARGING, &amp;di-&gt;event_nb);</code> 回调是 <code>bat_core_event_notifier_call()</code>，把事件映射为充电状态：</p><ul><li>POWER_NE_CHARGING_START → POWER_SUPPLY_STATUS_CHARGING</li><li>POWER_NE_CHARGING_STOP → DISCHARGING</li><li>POWER_NE_CHARGING_SUSPEND → NOT_CHARGING</li></ul><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_core_event_notifier_call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> notifier_block </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">nb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (event) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_NE_CHARGING_START:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_STATUS_CHARGING;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 开始充电</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_NE_CHARGING_STOP:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_STATUS_DISCHARGING;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 停止充电</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_NE_CHARGING_SUSPEND:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_SUPPLY_STATUS_NOT_CHARGING;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 充电暂停</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bat_core_update_charge_status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di, status);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>然后进 <code>bat_core_update_charge_status(di, status)</code>：</p><ul><li>如果正在充电且 ui_capacity==100，强制变成 FULL</li><li>状态发生变化时会调用： <ul><li>power_supply_sync_changed(&quot;Battery&quot;);</li><li>power_supply_sync_changed(&quot;battery&quot;);</li></ul></li></ul><p>这一步非常关键：<strong>它让系统/上层（包括 framework/界面）立刻感知状态变更，而不是等下一个 work 周期</strong>。</p><h3 id="_2-8-双库仑计支持" tabindex="-1">2.8 双库仑计支持 <a class="header-anchor" href="#_2-8-双库仑计支持" aria-label="Permalink to &quot;2.8 双库仑计支持&quot;">​</a></h3><p>DTS 里会读 coul_type：</p><ul><li>COUL_TYPE_MAIN</li><li>COUL_TYPE_AUX</li></ul><p>或者两者都注册</p><p>bat_core_reg_guage_psy() 会按配置注册：</p><ul><li>battery_gauge</li><li>battery_gauge_aux</li></ul><p>并且 bat_core_get_prop() 会通过 psy == di-&gt;aux_psy 来区分 type（main/aux），对同一套属性返回不同来源的数据。</p><h3 id="_2-9-电池故障通知" tabindex="-1">2.9 电池故障通知 <a class="header-anchor" href="#_2-9-电池故障通知" aria-label="Permalink to &quot;2.9 电池故障通知&quot;">​</a></h3><p>驱动注册了 <code>bat_fault_register_ops(&amp;g_bat_core_fault_ops)</code>，注册到故障管理模块</p><p>当 <code>bat_core_fault_notify(event)</code> 收到：POWER_NE_COUL_LOW_VOL 会 mod_delayed_work(..., 0) 立刻调度一次 monitor_work，把低压状态尽快刷新给系统。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	bat_fault_register_ops</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">g_bat_core_fault_ops</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fault_ops g_bat_core_fault_ops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	.notify </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_fault_notify,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_core_fault_notify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_core_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> g_bat_core_dev;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (event) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 如果是POWER_NE_COUL_LOW_VOL，也就是低压状态立即刷新work</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_NE_COUL_LOW_VOL:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		mod_delayed_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(system_freezable_power_efficient_wq, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">monitor_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">			msecs_to_jiffies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	hwlog_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;fault event notify=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, event);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>其实就是通知链，当其他模块call chain时会调用到这里 比如在<code>bat_fault_cutoff_vol_event_handle</code>中</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_fault_cutoff_vol_event_handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fault_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">di</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	bat_fault_notify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POWER_NE_COUL_LOW_VOL);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="三、dts配置解析" tabindex="-1">三、DTS配置解析 <a class="header-anchor" href="#三、dts配置解析" aria-label="Permalink to &quot;三、DTS配置解析&quot;">​</a></h2><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_core_parse_dts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. 库仑计类型</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    coul_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COUL_TYPE_MAIN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COUL_TYPE_AUX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COUL_TYPE_BOTH</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. 温度类型</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    temp_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_CORE_TEMP_TYPE_RAW_COMP </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_CORE_TEMP_TYPE_MIXED</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. NTC 温度补偿参数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ntc_compensation_is </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ntc_temp_compensation_para </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 充电电流 1000mA, 补偿 -2°C</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        2000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 充电电流 2000mA, 补偿 -5°C</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4. 电压/容量缩放系数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    voltage_now_scale </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // μV</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    voltage_max_scale </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    charge_fcc_scale </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // μAh</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="四、初始化流程" tabindex="-1">四、初始化流程 <a class="header-anchor" href="#四、初始化流程" aria-label="Permalink to &quot;四、初始化流程&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>bat_core_probe()</span></span>
<span class="line"><span>├── 1. 分配设备结构体</span></span>
<span class="line"><span>├── 2. 解析 DTS 配置</span></span>
<span class="line"><span>├── 3. 初始化数据 (默认值)</span></span>
<span class="line"><span>├── 4. 注册 Power Supply 操作集</span></span>
<span class="line"><span>├── 5. 注册充电事件通知</span></span>
<span class="line"><span>├── 6. 注册 battery_gauge PSY</span></span>
<span class="line"><span>├── 7. 创建唤醒锁</span></span>
<span class="line"><span>├── 8. 启动监控任务</span></span>
<span class="line"><span>└── 9. 注册故障回调</span></span></code></pre></div><h2 id="五、模块依赖" tabindex="-1">五、模块依赖 <a class="header-anchor" href="#五、模块依赖" aria-label="Permalink to &quot;五、模块依赖&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_core.c</span></span>
<span class="line"><span>├── coul_interface (库仑计接口)</span></span>
<span class="line"><span>├── bat_ui_capacity (UI 电量算法)</span></span>
<span class="line"><span>├── bat_model (电池模型)</span></span>
<span class="line"><span>├── bat_temp (温度管理)</span></span>
<span class="line"><span>├── bat_fault (故障检测)</span></span>
<span class="line"><span>└── power_supply (Linux 电源框架)</span></span></code></pre></div><h2 id="六、调试接口" tabindex="-1">六、调试接口 <a class="header-anchor" href="#六、调试接口" aria-label="Permalink to &quot;六、调试接口&quot;">​</a></h2><ol><li>查看日志关键字: battery_core</li><li>监控节点: <ul><li>/sys/class/power_supply/battery_gauge/</li><li>/sys/class/power_supply/battery_gauge_aux/</li></ul></li><li>关键函数打点: <ul><li>bat_core_update_charge_status()</li><li>bat_core_update_health()</li><li>bat_core_work()</li></ul></li></ol><h2 id="七、流程图" tabindex="-1">七、流程图 <a class="header-anchor" href="#七、流程图" aria-label="Permalink to &quot;七、流程图&quot;">​</a></h2><p><img src="`+h+'" alt=""></p>',71)),i("p",null,[s[0]||(s[0]=l("高清大图：",-1)),i("a",{href:p(k),target:"_blank",rel:"noreferrer"},"流程图高清",8,e)])]))}});export{c as __pageData,y as default};
