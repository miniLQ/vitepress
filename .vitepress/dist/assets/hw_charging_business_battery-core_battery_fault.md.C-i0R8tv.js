import{_ as i,c as a,o as n,a0 as l}from"./chunks/framework.Cee10E_e.js";const g=JSON.parse('{"title":"华为电池核心之battery_fault模块","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"hw_charging/business/battery-core/battery_fault.md","filePath":"hw_charging/business/battery-core/battery_fault.md"}'),t={name:"hw_charging/business/battery-core/battery_fault.md"};function p(h,s,e,k,E,d){return n(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="华为电池核心之battery-fault模块" tabindex="-1">华为电池核心之battery_fault模块 <a class="header-anchor" href="#华为电池核心之battery-fault模块" aria-label="Permalink to &quot;华为电池核心之battery_fault模块&quot;">​</a></h1><h2 id="一、模块概述" tabindex="-1">一、模块概述 <a class="header-anchor" href="#一、模块概述" aria-label="Permalink to &quot;一、模块概述&quot;">​</a></h2><p>[battery_fault.c]是华为电源管理框架中的电池故障检测驱动，核心功能：</p><ul><li>电池欠压保护（截止电压检测）</li><li>低温/休眠状态下的电压调整</li><li>故障事件通知与 DSM 上报</li><li>防误触发滤波机制</li></ul><h2 id="二、核心数据结构" tabindex="-1">二、核心数据结构 <a class="header-anchor" href="#二、核心数据结构" aria-label="Permalink to &quot;二、核心数据结构&quot;">​</a></h2><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fault_device {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> delayed_work fault_work;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 延迟工作队列</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> notifier_block coul_event_nb;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 库仑计事件通知</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fault_config config;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 配置参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fault_data data;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // 运行时数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wakeup_source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wake_lock;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 唤醒锁</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fault_ops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ops;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 回调操作</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 配置参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fault_config {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vol_cutoff_normal;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 正常模式截止电压 (默认 3150mV)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vol_cutoff_sleep;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 休眠模式截止电压 (默认 3350mV)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vol_cutoff_low_temp;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 低温截止电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vol_cutoff_filter_cnt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 滤波次数 (默认 3 次)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 运行数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fault_data {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vol_cutoff_sign;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 截止标志 (1=已触发欠压)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vol_cutoff_used;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 当前使用的截止电压阈值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 回调接口</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fault_ops {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">notify)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 故障通知回调</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h2 id="三、关键功能模块" tabindex="-1">三、关键功能模块 <a class="header-anchor" href="#三、关键功能模块" aria-label="Permalink to &quot;三、关键功能模块&quot;">​</a></h2><h3 id="_3-1-截止电压动态更新" tabindex="-1">3.1 截止电压动态更新 <a class="header-anchor" href="#_3-1-截止电压动态更新" aria-label="Permalink to &quot;3.1 截止电压动态更新&quot;">​</a></h3><h4 id="_3-1-1-策略逻辑" tabindex="-1">3.1.1 策略逻辑 <a class="header-anchor" href="#_3-1-1-策略逻辑" aria-label="Permalink to &quot;3.1.1 策略逻辑&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_fault_update_cutoff_vol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> sleep_mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. 根据系统状态选择基准电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (sleep_mode)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        vol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vol_cutoff_sleep;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 休眠: 3350mV (更保守)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        vol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vol_cutoff_normal;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 正常: 3150mV</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. 低温保护 (温度 ≤ -5°C)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> coul_interface_get_battery_temperature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_FAULT_LOW_TEMP_THLD)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // -50 (表示 -5.0°C)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        vol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(vol_cutoff_low_temp, vol);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 使用更低的阈值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. 更新使用的截止电压</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    di-&gt;data.vol_cutoff_used </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vol;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_3-1-2-温度单位说明" tabindex="-1">3.1.2 温度单位说明 <a class="header-anchor" href="#_3-1-2-温度单位说明" aria-label="Permalink to &quot;3.1.2 温度单位说明&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BAT_FAULT_LOW_TEMP_THLD </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 表示 -5.0°C (温度 × 10)</span></span></code></pre></div><p>应用场景：</p><table tabindex="0"><thead><tr><th style="text-align:center;">状态</th><th style="text-align:center;">温度</th><th style="text-align:center;">使用电压</th><th style="text-align:center;">原因</th></tr></thead><tbody><tr><td style="text-align:center;">正常使用</td><td style="text-align:center;">常温</td><td style="text-align:center;">3150mV</td><td style="text-align:center;">最大化电量利用</td></tr><tr><td style="text-align:center;">休眠状态</td><td style="text-align:center;">常温</td><td style="text-align:center;">3350mV</td><td style="text-align:center;">防止长时间放置过放</td></tr><tr><td style="text-align:center;">正常使用</td><td style="text-align:center;">低温</td><td style="text-align:center;">低温电压</td><td style="text-align:center;">低温内阻大，电压跌落快</td></tr></tbody></table><h3 id="_3-2-欠压检测和滤波" tabindex="-1">3.2 欠压检测和滤波 <a class="header-anchor" href="#_3-2-欠压检测和滤波" aria-label="Permalink to &quot;3.2 欠压检测和滤波&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_fault_cutoff_vol_event_handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. 前置条件检查</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bat_exist)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 电池不存在，退出</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. 多次滤波验证 (默认 3 次)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di-&gt;config.vol_cutoff_filter_cnt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voltage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> coul_interface_get_battery_voltage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 允许 10mV 偏差容差</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((voltage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_FAULT_CUTOFF_VOL_OFFSET) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cutoff_vol) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            hwlog_err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;filter fail:vol=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, voltage);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 滤波失败，不是真实欠压</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            msleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(BAT_FAULT_CUTOFF_VOL_PERIOD);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 等待 1000ms</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. 确认欠压，设置标志</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    di-&gt;data.vol_cutoff_sign </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4. 通知其他模块</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bat_fault_notify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POWER_NE_COUL_LOW_VOL);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 5. 上报 DSM 日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    snprintf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buf, ..., </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;[LOW VOL]cur_vol:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mV,cut_vol=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mV,cur_soc=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,temp=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,current=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        voltage, cutoff_vol, ui_soc, temp, cur);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    power_dsm_report_dmd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POWER_DSM_BATTERY_DETECT,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        POWER_DSM_ERROR_LOW_VOL_INT, buf);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>时间轴:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span> t0         t1         t2         t3</span></span>
<span class="line"><span> ↓          ↓          ↓          ↓</span></span>
<span class="line"><span>读取 -----&gt; 读取 ----&gt; 读取 ----&gt; 确认欠压</span></span>
<span class="line"><span>          (1s)       (1s)</span></span></code></pre></div><p>如果任意一次电压 &gt; (cutoff + 10mV) → 退出，认为误触发</p><h3 id="_3-3-欠压判断入口" tabindex="-1">3.3 欠压判断入口 <a class="header-anchor" href="#_3-3-欠压判断入口" aria-label="Permalink to &quot;3.3 欠压判断入口&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_fault_is_cutoff_vol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. 快速路径：已标记欠压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (di-&gt;data.vol_cutoff_sign)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di-&gt;data.vol_cutoff_sign;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 返回 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. 更新截止电压阈值</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bat_fault_update_cutoff_vol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. 实时检测</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    voltage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> coul_interface_get_battery_voltage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (voltage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di-&gt;data.vol_cutoff_used) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        hwlog_err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;battery voltage low </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, cutoff </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            voltage, di-&gt;data.vol_cutoff_used);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 触发库仑计低压事件 (会启动滤波验证)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_event_bnc_notify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POWER_BNT_COUL, POWER_NE_COUL_LOW_VOL, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di-&gt;data.vol_cutoff_sign;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>调用链：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_core.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (健康度检测)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ↓</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_fault_is_cutoff_vol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ↓</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">voltage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cutoff_vol </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ↓ (是)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">power_event_bnc_notify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POWER_NE_COUL_LOW_VOL)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ↓</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_fault_coul_event_notifier_call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ↓</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queue_delayed_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fault_work)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ↓</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_fault_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ↓</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_fault_cutoff_vol_event_handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><h3 id="_3-4-欠压事件通知" tabindex="-1">3.4 欠压事件通知 <a class="header-anchor" href="#_3-4-欠压事件通知" aria-label="Permalink to &quot;3.4 欠压事件通知&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_fault_send_under_voltage_event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> power_event_notify_data n_data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 构造 uevent 数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    n_data.event </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;BATTERY_UNDER_VOLTAGE=1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    n_data.event_len </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 发送到用户空间 (Android 系统)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    power_event_report_uevent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n_data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    hwlog_info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;battery under voltage, report uevent</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-5-库仑计事件监听" tabindex="-1">3.5 库仑计事件监听 <a class="header-anchor" href="#_3-5-库仑计事件监听" aria-label="Permalink to &quot;3.5 库仑计事件监听&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_fault_coul_event_notifier_call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> notifier_block </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">nb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (event) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> POWER_NE_COUL_LOW_VOL:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 立即调度工作队列 (延迟 0ms)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        queue_delayed_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(system_power_efficient_wq, </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fault_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">msecs_to_jiffies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NOTIFY_OK;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-6-故障回调通知" tabindex="-1">3.6 故障回调通知 <a class="header-anchor" href="#_3-6-故障回调通知" aria-label="Permalink to &quot;3.6 故障回调通知&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_fault_notify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di-&gt;ops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">di-&gt;ops-&gt;notify)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 调用注册的回调函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    di-&gt;ops-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">notify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 外部模块注册回调</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_fault_register_ops</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_fault_ops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ops</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    di-&gt;ops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ops;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-7-dts配置解析" tabindex="-1">3.7 DTS配置解析 <a class="header-anchor" href="#_3-7-dts配置解析" aria-label="Permalink to &quot;3.7 DTS配置解析&quot;">​</a></h3><p>支持硅基/石墨基差异化配置：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_fault_parse_dts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 根据电池阴极类型选择不同参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_model_get_bat_cathode_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_MODEL_BAT_CATHODE_TYPE_SILICON:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 硅基电池参数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_dts_read_u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vol_cutoff_normal_si&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ...);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_dts_read_u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vol_cutoff_sleep_si&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ...);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_dts_read_u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vol_cutoff_low_temp_si&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ...);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_dts_read_u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vol_cutoff_filter_cnt_si&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ...);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BAT_MODEL_BAT_CATHODE_TYPE_GRAPHITE:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 石墨基电池参数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_dts_read_u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vol_cutoff_normal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ...);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_dts_read_u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vol_cutoff_sleep&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ...);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_dts_read_u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vol_cutoff_low_temp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ...);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        power_dts_read_u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vol_cutoff_filter_cnt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ...);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>DTS 示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_fault {</span></span>
<span class="line"><span>    compatible = &quot;huawei,battery_fault&quot;;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 石墨基电池配置 */</span></span>
<span class="line"><span>    vol_cutoff_normal = &lt;3150&gt;;        // 正常模式 3.15V</span></span>
<span class="line"><span>    vol_cutoff_sleep = &lt;3350&gt;;         // 休眠模式 3.35V</span></span>
<span class="line"><span>    vol_cutoff_low_temp = &lt;3000&gt;;      // 低温模式 3.00V</span></span>
<span class="line"><span>    vol_cutoff_filter_cnt = &lt;3&gt;;       // 滤波 3 次</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 硅基电池配置 (电压特性不同) */</span></span>
<span class="line"><span>    vol_cutoff_normal_si = &lt;3000&gt;;     // 硅基电池截止电压更低</span></span>
<span class="line"><span>    vol_cutoff_sleep_si = &lt;3200&gt;;</span></span>
<span class="line"><span>    vol_cutoff_low_temp_si = &lt;2850&gt;;</span></span>
<span class="line"><span>    vol_cutoff_filter_cnt_si = &lt;5&gt;;    // 更严格的滤波</span></span>
<span class="line"><span>};</span></span></code></pre></div><h3 id="_3-8-电源管理" tabindex="-1">3.8 电源管理 <a class="header-anchor" href="#_3-8-电源管理" aria-label="Permalink to &quot;3.8 电源管理&quot;">​</a></h3><p>休眠/唤醒处理：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 系统准备休眠</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_fault_prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dev</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. 切换到休眠模式电压阈值 (更高)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bat_fault_update_cutoff_vol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. 通知库仑计芯片更新中断阈值</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    coul_interface_set_battery_low_voltage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        bat_core_get_coul_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), di-&gt;data.vol_cutoff_used);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 系统唤醒完成</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_fault_complete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dev</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. 切换回正常模式电压阈值 (更低)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bat_fault_update_cutoff_vol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. 通知库仑计芯片更新中断阈值</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    coul_interface_set_battery_low_voltage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        bat_core_get_coul_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), di-&gt;data.vol_cutoff_used);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>休眠时提高阈值：防止长时间休眠导致电池过放损坏</li><li>唤醒后降低阈值：最大化电量利用，延长续航</li></ul><h3 id="_3-9-debug调试接口" tabindex="-1">3.9 debug调试接口 <a class="header-anchor" href="#_3-9-debug调试接口" aria-label="Permalink to &quot;3.9 debug调试接口&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 查看当前截止电压</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_fault_dbg_vol_cutoff_show</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> scnprintf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buf, size, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vol_cutoff_used is </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        di-&gt;data.vol_cutoff_used);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 动态修改截止电压 (调试用)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_fault_dbg_vol_cutoff_store</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">buf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">size_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    kstrtoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buf, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">val);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    di-&gt;config.vol_cutoff_normal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> val;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bat_fault_update_cutoff_vol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>使用方法：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># 查看当前截止电压</span></span>
<span class="line"><span>cat /sys/kernel/debug/power/bat_fault/vol_cutoff</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 设置新的截止电压 (调试)</span></span>
<span class="line"><span>echo 3100 &gt; /sys/kernel/debug/power/bat_fault/vol_cutoff</span></span></code></pre></div><h2 id="四、初始化流程" tabindex="-1">四、初始化流程 <a class="header-anchor" href="#四、初始化流程" aria-label="Permalink to &quot;四、初始化流程&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>bat_fault_probe()</span></span>
<span class="line"><span>├── 1. 分配设备结构体 (kzalloc)</span></span>
<span class="line"><span>├── 2. 解析 DTS 配置</span></span>
<span class="line"><span>│   └── 根据电池类型 (硅基/石墨基) 选择参数</span></span>
<span class="line"><span>├── 3. 注册 Debug 接口</span></span>
<span class="line"><span>├── 4. 初始化截止电压 (休眠模式)</span></span>
<span class="line"><span>│   └── bat_fault_update_cutoff_vol(true)</span></span>
<span class="line"><span>├── 5. 创建延迟工作队列</span></span>
<span class="line"><span>│   └── INIT_DELAYED_WORK(&amp;fault_work, bat_fault_work)</span></span>
<span class="line"><span>├── 6. 注册库仑计事件监听</span></span>
<span class="line"><span>│   └── power_event_bnc_register(POWER_BNT_COUL, &amp;coul_event_nb)</span></span>
<span class="line"><span>├── 7. 创建唤醒锁</span></span>
<span class="line"><span>│   └── power_wakeup_source_register()</span></span>
<span class="line"><span>└── 8. 设置全局指针 g_bat_fault_dev</span></span></code></pre></div><h2 id="五、关键宏定义" tabindex="-1">五、关键宏定义 <a class="header-anchor" href="#五、关键宏定义" aria-label="Permalink to &quot;五、关键宏定义&quot;">​</a></h2><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BAT_FAULT_NORMAL_CUTOFF_VOL   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3150</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 正常截止电压 3.15V</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BAT_FAULT_SLEEP_CUTOFF_VOL    </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3350</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 休眠截止电压 3.35V</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BAT_FAULT_CUTOFF_VOL_OFFSET   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 滤波容差 10mV</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BAT_FAULT_CUTOFF_VOL_FILTERS  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 滤波次数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BAT_FAULT_CUTOFF_VOL_PERIOD   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 滤波间隔 1000ms</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BAT_FAULT_LOW_TEMP_THLD       </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // 低温阈值 -5.0°C</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BAT_FAULT_DSM_BUF_SIZE        </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">256</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // DSM 缓冲区大小</span></span></code></pre></div><h2 id="六、典型应用场景" tabindex="-1">六、典型应用场景 <a class="header-anchor" href="#六、典型应用场景" aria-label="Permalink to &quot;六、典型应用场景&quot;">​</a></h2><h3 id="_6-1-正常使用突然欠压" tabindex="-1">6.1 正常使用突然欠压 <a class="header-anchor" href="#_6-1-正常使用突然欠压" aria-label="Permalink to &quot;6.1 正常使用突然欠压&quot;">​</a></h3><ol><li>用户使用手机，电量显示 3%</li><li>电压读数 3140mV &lt; 3150mV (截止电压)</li><li>bat_fault_is_cutoff_vol() 检测到欠压</li><li>触发 POWER_NE_COUL_LOW_VOL 事件</li><li>启动延迟工作队列，进行 3 次滤波验证 <ul><li>t=0s: voltage = 3140mV ✓</li><li>t=1s: voltage = 3135mV ✓</li><li>t=2s: voltage = 3130mV ✓</li></ul></li><li>确认真实欠压 <ul><li>vol_cutoff_sign = 1</li><li>通知 battery_core 更新健康状态</li><li>上报 DSM: &quot;[LOW VOL]cur_vol:3130mV,cut_vol=3150mV,cur_soc=3,...&quot;</li></ul></li><li>battery_core 设置健康度 = POWER_SUPPLY_HEALTH_UNDERVOLTAGE</li><li>发送 uevent 到 Android 层</li><li>Android 触发关机流程</li></ol><h3 id="_6-2-充电时误触发-负载突降" tabindex="-1">6.2 充电时误触发（负载突降） <a class="header-anchor" href="#_6-2-充电时误触发-负载突降" aria-label="Permalink to &quot;6.2 充电时误触发（负载突降）&quot;">​</a></h3><ol><li>用户插入充电器瞬间</li><li>充电电流突增，电池内阻压降导致电压瞬降</li><li>瞬时读数 3140mV &lt; 3150mV</li><li>触发第 1 次滤波检测: voltage = 3140mV ✓</li><li>等待 1s，充电稳定后</li><li>第 2 次滤波检测: voltage = 3600mV ✗ (超过阈值)</li><li>滤波失败，认为误触发，退出</li><li>vol_cutoff_sign 保持 0，不触发关机</li></ol><h3 id="_6-3-低温环境欠压" tabindex="-1">6.3 低温环境欠压 <a class="header-anchor" href="#_6-3-低温环境欠压" aria-label="Permalink to &quot;6.3 低温环境欠压&quot;">​</a></h3><ol><li>环境温度 -10°C</li><li>电池温度读数 -100 (表示 -10.0°C) &lt; -50</li><li>bat_fault_update_cutoff_vol() 选择低温截止电压 <ul><li>vol_cutoff_used = min(vol_cutoff_low_temp, vol_cutoff_normal)</li><li>假设 vol_cutoff_low_temp = 3000mV</li></ul></li><li>使用更低的阈值 3000mV 进行判断</li><li>避免低温下内阻大导致的误关机</li></ol><h3 id="_6-4-休眠期间长时间放置" tabindex="-1">6.4 休眠期间长时间放置 <a class="header-anchor" href="#_6-4-休眠期间长时间放置" aria-label="Permalink to &quot;6.4 休眠期间长时间放置&quot;">​</a></h3><ol><li>手机进入休眠 (suspend)</li><li>bat_fault_prepare() 被调用</li><li>切换到休眠截止电压 3350mV (更高)</li><li>通知库仑计芯片更新中断阈值</li><li>库仑计硬件监控电压</li><li>如果电压 &lt; 3350mV，触发硬件中断唤醒系统</li><li>系统执行关机流程，防止过放</li></ol><h2 id="七、模块依赖" tabindex="-1">七、模块依赖 <a class="header-anchor" href="#七、模块依赖" aria-label="Permalink to &quot;七、模块依赖&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_fault.c</span></span>
<span class="line"><span>├── coul_interface (库仑计接口)</span></span>
<span class="line"><span>│   ├── get_battery_voltage()</span></span>
<span class="line"><span>│   ├── get_battery_temperature()</span></span>
<span class="line"><span>│   ├── get_battery_avg_current()</span></span>
<span class="line"><span>│   ├── is_battery_exist()</span></span>
<span class="line"><span>│   └── set_battery_low_voltage()</span></span>
<span class="line"><span>├── battery_core (电池核心)</span></span>
<span class="line"><span>│   └── bat_core_get_coul_type()</span></span>
<span class="line"><span>├── battery_ui_capacity (UI 电量)</span></span>
<span class="line"><span>│   └── bat_ui_capacity()</span></span>
<span class="line"><span>├── battery_model (电池型号)</span></span>
<span class="line"><span>│   └── bat_model_get_bat_cathode_type()</span></span>
<span class="line"><span>├── power_event (事件通知)</span></span>
<span class="line"><span>│   ├── power_event_bnc_notify()</span></span>
<span class="line"><span>│   └── power_event_report_uevent()</span></span>
<span class="line"><span>└── power_dsm (DSM 上报)</span></span>
<span class="line"><span>    └── power_dsm_report_dmd()</span></span></code></pre></div><h2 id="八、电压阈值设计原理" tabindex="-1">八、电压阈值设计原理 <a class="header-anchor" href="#八、电压阈值设计原理" aria-label="Permalink to &quot;八、电压阈值设计原理&quot;">​</a></h2><p>为什么需要不同的截止电压？</p><table tabindex="0"><thead><tr><th style="text-align:center;">场景</th><th style="text-align:center;">截止电压</th><th style="text-align:center;">原因</th></tr></thead><tbody><tr><td style="text-align:center;">正常使用</td><td style="text-align:center;">3150mV</td><td style="text-align:center;">最大化电量利用，避免过早关机</td></tr><tr><td style="text-align:center;">休眠状态</td><td style="text-align:center;">3350mV</td><td style="text-align:center;">防止长时间静置导致过放损坏电池</td></tr><tr><td style="text-align:center;">低温环境</td><td style="text-align:center;">3000mV</td><td style="text-align:center;">低温内阻大，电压跌落快，降低阈值避免误关机</td></tr><tr><td style="text-align:center;">滤波容差设计：</td><td style="text-align:center;"></td><td style="text-align:center;"></td></tr></tbody></table><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>实际判断条件: voltage &lt; (cutoff_vol + 10mV)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>原因:</span></span>
<span class="line"><span>1. ADC 读数有 ±5mV 误差</span></span>
<span class="line"><span>2. 电池内阻导致瞬时压降</span></span>
<span class="line"><span>3. 10mV 容差可过滤大部分毛刺</span></span></code></pre></div><h2 id="九、调试建议" tabindex="-1">九、调试建议 <a class="header-anchor" href="#九、调试建议" aria-label="Permalink to &quot;九、调试建议&quot;">​</a></h2><p>日志关键词</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>dmesg | grep battery_fault</span></span>
<span class="line"><span>dmesg | grep &quot;LOW VOL&quot;</span></span>
<span class="line"><span>dmesg | grep &quot;cutoff&quot;</span></span></code></pre></div><p>关键日志示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_fault: v_cut=3150, v_sleep=3350, v_low_temp=3000, temp=250, vol=3150</span></span>
<span class="line"><span>battery_fault: filter fail:vol=3200,count=2,v_cut=3150</span></span>
<span class="line"><span>battery_fault: cutoff:vol=3130,v_cut=3150,cur_soc=3</span></span>
<span class="line"><span>battery_fault: battery under voltage, report uevent</span></span></code></pre></div><p>Debug 节点：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看当前截止电压</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/debug/power/bat_fault/vol_cutoff</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 临时修改截止电压 (测试用)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/debug/power/bat_fault/vol_cutoff</span></span></code></pre></div><p>模拟欠压测试：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 降低截止电压阈值</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3800</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/debug/power/bat_fault/vol_cutoff</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 观察日志，应该立即触发欠压检测</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dmesg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -20</span></span></code></pre></div><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p><code>battery_fault</code>是电池安全的最后一道防线，通过多级滤波和动态阈值调整，准确识别真实欠压，防止电池过放损坏，同时避免误触发影响用户体验。</p>`,72)])])}const c=i(t,[["render",p]]);export{g as __pageData,c as default};
