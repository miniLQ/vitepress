import{_ as l,C as p,c as h,o as i,a0 as a,b as e,w as n,a as k,G as d,a1 as r}from"./chunks/framework.Cee10E_e.js";const D=JSON.parse('{"title":"华为电池核心之battery_model模块","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"hw_charging/business/battery-core/battery_model.md","filePath":"hw_charging/business/battery-core/battery_model.md"}'),E={name:"hw_charging/business/battery-core/battery_model.md"};function g(o,s,c,y,_,A){const t=p("Mermaid");return i(),h("div",null,[s[1]||(s[1]=a(`<h1 id="华为电池核心之battery-model模块" tabindex="-1">华为电池核心之battery_model模块 <a class="header-anchor" href="#华为电池核心之battery-model模块" aria-label="Permalink to &quot;华为电池核心之battery_model模块&quot;">​</a></h1><p>如果你做过 Android / Linux 设备，大概率见过这些现象：</p><ul><li>手机明明还有 20%，突然几分钟掉到 5%</li><li>低温环境下电量掉得特别快</li><li>充到 99% 卡半天，或者 99% ↔ 100% 来回跳</li></ul><p><strong>问题不是 UI 写错了，而是：</strong><strong>真实世界的电池，本来就不“听话”。</strong></p><blockquote><p>battery_model 是一个“把真实电池变得看起来很乖”的软件模型。</p></blockquote><p>硬件给我们的，其实是一些很不友好的原始数据：</p><ul><li>电压（会随负载剧烈变化）</li><li>温度（慢半拍，还不线性）</li><li>剩余容量（会抖）</li></ul><p>如果你直接把这些数据显示给用户——体验一定很差。 所以系统里一般会有两层：</p><h2 id="一、模块概述" tabindex="-1">一、模块概述 <a class="header-anchor" href="#一、模块概述" aria-label="Permalink to &quot;一、模块概述&quot;">​</a></h2><h3 id="_1-1-基本定位" tabindex="-1">1.1 基本定位 <a class="header-anchor" href="#_1-1-基本定位" aria-label="Permalink to &quot;1.1 基本定位&quot;">​</a></h3><p>battery_model模块是华为电池管理系统的核心数据管理模块，负责电池型号识别、参数管理、品牌信息提取等关键功能。该模块作为电池系统的&quot;身份证管理器&quot;，为其他电池相关模块提供统一的电池模型数据接口。</p><h3 id="_1-2-主要职责" tabindex="-1">1.2 主要职责 <a class="header-anchor" href="#_1-2-主要职责" aria-label="Permalink to &quot;1.2 主要职责&quot;">​</a></h3><ul><li>电池型号识别：通过电压检测或类型匹配识别具体电池型号</li><li>参数管理：管理电池的满充容量（FCC）、最大电压、技术类型等关键参数</li><li>品牌信息提取：从电池型号名称中解析品牌信息</li><li>电池类型检测：识别石墨/硅基等不同阴极材料的电池</li><li>配置管理：通过设备树动态加载电池型号配置表</li></ul><h2 id="二、核心功能详解" tabindex="-1">二、核心功能详解 <a class="header-anchor" href="#二、核心功能详解" aria-label="Permalink to &quot;二、核心功能详解&quot;">​</a></h2><h3 id="_2-1-电池型号识别机制" tabindex="-1">2.1 电池型号识别机制 <a class="header-anchor" href="#_2-1-电池型号识别机制" aria-label="Permalink to &quot;2.1 电池型号识别机制&quot;">​</a></h3><p>模块支持多种电池识别方式，按优先级顺序执行： // 识别流程（battery_model.c:317-367）</p><ol><li>类型匹配优先：通过电池SN类型字符串匹配</li><li>IIO电压读取：使用IIO子系统读取电池ID电压</li><li>ADC电压读取：通过传统ADC通道读取电压</li><li>默认值回退：所有方法失败时使用默认配置</li></ol><h4 id="_2-1-1-类型匹配-bat-model-get-index-by-type" tabindex="-1">2.1.1 类型匹配（bat_model_get_index_by_type） <a class="header-anchor" href="#_2-1-1-类型匹配-bat-model-get-index-by-type" aria-label="Permalink to &quot;2.1.1 类型匹配（bat_model_get_index_by_type）&quot;">​</a></h4><ul><li>输入：电池SN类型字符串（如&quot;ATL&quot;、&quot;LGC&quot;等）</li><li>处理：在电池型号表中查找匹配的SN类型</li><li>输出：对应的电池型号索引</li><li>特殊处理：硅基电池在类型后添加&quot;S&quot;后缀标识</li></ul><h4 id="_2-1-2-电压匹配-bat-model-get-index-by-iio" tabindex="-1">2.1.2 电压匹配（bat_model_get_index_by_iio） <a class="header-anchor" href="#_2-1-2-电压匹配-bat-model-get-index-by-iio" aria-label="Permalink to &quot;2.1.2 电压匹配（bat_model_get_index_by_iio）&quot;">​</a></h4><ul><li>输入：电池ID引脚电压值（通过IIO或ADC读取）</li><li>处理：在电压范围表中查找匹配的区间</li><li>输出：对应的电池型号索引</li><li>电压表结构：每个型号有低电压和高电压范围</li></ul><h3 id="_2-2-电池参数管理" tabindex="-1">2.2 电池参数管理 <a class="header-anchor" href="#_2-2-电池参数管理" aria-label="Permalink to &quot;2.2 电池参数管理&quot;">​</a></h3><p>模块管理以下关键电池参数：</p><table tabindex="0"><thead><tr><th>参数</th><th>函数</th><th>说明</th></tr></thead><tbody><tr><td>最大电压</td><td>bat_model_get_vbat_max()</td><td>电池最大充电电压</td></tr><tr><td>设计FCC</td><td>bat_model_get_design_fcc()</td><td>设计满充容量</td></tr><tr><td>实际FCC</td><td>bat_model_get_fcc()</td><td>实际满充容量</td></tr><tr><td>技术类型</td><td>bat_model_get_technology()</td><td>电池技术（Li-ion等）</td></tr><tr><td>品牌信息</td><td>bat_model_get_brand()</td><td>电池品牌名称</td></tr></tbody></table><h3 id="_2-3-电池阴极类型检测" tabindex="-1">2.3 电池阴极类型检测 <a class="header-anchor" href="#_2-3-电池阴极类型检测" aria-label="Permalink to &quot;2.3 电池阴极类型检测&quot;">​</a></h3><p>支持石墨/硅基电池识别：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 阴极类型枚举（battery_model_public.h:34-39）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  enum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      BAT_MODEL_BAT_CATHODE_TYPE_INVALID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      BAT_MODEL_BAT_CATHODE_TYPE_GRAPHITE,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 石墨阴极</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      BAT_MODEL_BAT_CATHODE_TYPE_SILICON,</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 硅基阴极</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      BAT_MODEL_BAT_CATHODE_TYPE_MAX,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 检测函数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_get_bat_cathode_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 返回阴极类型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_match_silicon_battery</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 是否为硅基电池</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_match_graphite_battery</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 是否为石墨电池</span></span></code></pre></div><h3 id="_2-4-电池标识符匹配" tabindex="-1">2.4 电池标识符匹配 <a class="header-anchor" href="#_2-4-电池标识符匹配" aria-label="Permalink to &quot;2.4 电池标识符匹配&quot;">​</a></h3><p>使用正则表达式匹配电池标识符：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 标识符匹配算法（battery_model.c:163-191）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_identifier_match</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">identifier_pattern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 1. 获取电池标识符代码</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 2. 使用正则表达式匹配模式</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 3. 返回匹配结果</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> power_regex_lite_is_matched</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(identifier_pattern, token);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><h2 id="三、数据结构分析" tabindex="-1">三、数据结构分析 <a class="header-anchor" href="#三、数据结构分析" aria-label="Permalink to &quot;三、数据结构分析&quot;">​</a></h2><h3 id="_3-1-核心数据结构" tabindex="-1">3.1 核心数据结构 <a class="header-anchor" href="#_3-1-核心数据结构" aria-label="Permalink to &quot;3.1 核心数据结构&quot;">​</a></h3><h4 id="_3-1-1-电池型号表结构-bat-model-table" tabindex="-1">3.1.1 电池型号表结构（bat_model_table） <a class="header-anchor" href="#_3-1-1-电池型号表结构-bat-model-table" aria-label="Permalink to &quot;3.1.1 电池型号表结构（bat_model_table）&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_model_table {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_MODEL_NAME_LEN];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 电池型号名称（32字节）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id_vol_low;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                       // ID电压下限</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id_vol_high;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      // ID电压上限</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> sn_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_MODEL_TYPE_LEN];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // SN类型字符串（4字节）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span></code></pre></div><h4 id="_3-1-2-电池类型表结构-bat-types-table" tabindex="-1">3.1.2 电池类型表结构（bat_types_table） <a class="header-anchor" href="#_3-1-2-电池类型表结构-bat-types-table" aria-label="Permalink to &quot;3.1.2 电池类型表结构（bat_types_table）&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_types_table {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_TYPES_LEN];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 电池类型（16字节）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> identifier_pattern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_IDENTIFIER_PATTERN_LEN];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 标识符模式（32字节）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span></code></pre></div><ul><li>功能：存储电池类型与标识符模式的映射关系</li><li>容量：BAT_TYPES_MAX_NUM = 8个类型</li></ul><h4 id="_3-1-3-设备数据结构-bat-model-device" tabindex="-1">3.1.3 设备数据结构（bat_model_device） <a class="header-anchor" href="#_3-1-3-设备数据结构-bat-model-device" aria-label="Permalink to &quot;3.1.3 设备数据结构（bat_model_device）&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_model_device {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                           // 设备指针</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_model_ops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ops;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // 操作函数集</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_model_table </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tables</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_MODEL_TABLE_ROWS];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 电池型号表</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_item_code </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">si_item_codes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_MODEL_SI_ITEM_CODE_ROWS];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // SI项目代码</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_types_table </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bat_types_tab</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_TYPES_MAX_NUM];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 电池类型表</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mutex update_lock;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     // 更新锁</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> si_item_codes_size;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                       // SI代码数量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_num;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                                  // 电池数量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_cathode_ext;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                          // 阴极扩展标志</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> table_size;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                               // 型号表大小</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id_adc_channel;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                           // ADC通道号</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id_index;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                                 // 当前ID索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> default_index;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                            // 默认索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fcc;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                                      // 满充容量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> design_fcc;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                               // 设计满充容量</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vbat_max;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                                 // 最大电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> technology;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                               // 技术类型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> support_iio;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     // IIO支持标志</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_iio_init;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                             // IIO初始化标志</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> iio_channel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id_iio;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   // IIO通道</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> brand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BAT_MODEL_BRAND_LEN];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              // 品牌名称</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_identifier_index;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     // 标识符索引</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_identifier_len;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                       // 标识符长度</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_qcom_fg;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                               // 高通电量计标志</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span></code></pre></div><h3 id="_3-2-操作函数接口-bat-model-ops" tabindex="-1">3.2 操作函数接口（bat_model_ops） <a class="header-anchor" href="#_3-2-操作函数接口-bat-model-ops" aria-label="Permalink to &quot;3.2 操作函数接口（bat_model_ops）&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_model_ops {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                               // 设备数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">get_vbat_max)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 获取最大电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">get_design_fcc)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 获取设计FCC</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">get_technology)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 获取技术类型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">is_removed)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 是否移除</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">get_brand)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // 获取品牌</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span></code></pre></div><h2 id="四、关键算法实现" tabindex="-1">四、关键算法实现 <a class="header-anchor" href="#四、关键算法实现" aria-label="Permalink to &quot;四、关键算法实现&quot;">​</a></h2><h3 id="_4-1-电池识别算法流程" tabindex="-1">4.1 电池识别算法流程 <a class="header-anchor" href="#_4-1-电池识别算法流程" aria-label="Permalink to &quot;4.1 电池识别算法流程&quot;">​</a></h3>`,43)),(i(),e(r,null,{default:n(()=>[d(t,{id:"mermaid-306",class:"mermaid",graph:"%20%20graph%20TD%0A%20%20%20%20%20%20A%5B%E5%BC%80%E5%A7%8B%E8%AF%86%E5%88%AB%5D%20--%3E%20B%7B%E7%B1%BB%E5%9E%8B%E5%8C%B9%E9%85%8D%E6%88%90%E5%8A%9F%3F%7D%0A%20%20%20%20%20%20B%20--%20%E6%98%AF%20--%3E%20C%5B%E8%BF%94%E5%9B%9E%E5%9E%8B%E5%8F%B7%E7%B4%A2%E5%BC%95%5D%0A%20%20%20%20%20%20B%20--%20%E5%90%A6%20--%3E%20D%7B%E6%94%AF%E6%8C%81%E9%AB%98%E9%80%9A%E7%94%B5%E9%87%8F%E8%AE%A1%3F%7D%0A%20%20%20%20%20%20D%20--%20%E6%98%AF%20--%3E%20E%5B%E9%80%9A%E8%BF%87power_platform%E8%8E%B7%E5%8F%96%E7%94%B5%E5%8E%8B%5D%0A%20%20%20%20%20%20D%20--%20%E5%90%A6%20--%3E%20F%7B%E6%94%AF%E6%8C%81IIO%3F%7D%0A%20%20%20%20%20%20F%20--%20%E6%98%AF%20--%3E%20G%5B%E9%80%9A%E8%BF%87IIO%E8%AF%BB%E5%8F%96%E7%94%B5%E5%8E%8B%5D%0A%20%20%20%20%20%20F%20--%20%E5%90%A6%20--%3E%20H%7BADC%E9%80%9A%E9%81%93%E6%9C%89%E6%95%88%3F%7D%0A%20%20%20%20%20%20H%20--%20%E6%98%AF%20--%3E%20I%5B%E9%80%9A%E8%BF%87ADC%E8%AF%BB%E5%8F%96%E7%94%B5%E5%8E%8B%5D%0A%20%20%20%20%20%20H%20--%20%E5%90%A6%20--%3E%20J%5B%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%5D%0A%20%20%20%20%20%20E%20--%3E%20K%5B%E5%9C%A8%E7%94%B5%E5%8E%8B%E8%A1%A8%E4%B8%AD%E6%9F%A5%E6%89%BE%E5%8C%B9%E9%85%8D%5D%0A%20%20%20%20%20%20G%20--%3E%20K%0A%20%20%20%20%20%20I%20--%3E%20K%0A%20%20%20%20%20%20K%20--%3E%20L%7B%E6%89%BE%E5%88%B0%E5%8C%B9%E9%85%8D%3F%7D%0A%20%20%20%20%20%20L%20--%20%E6%98%AF%20--%3E%20M%5B%E8%BF%94%E5%9B%9E%E5%9E%8B%E5%8F%B7%E7%B4%A2%E5%BC%95%5D%0A%20%20%20%20%20%20L%20--%20%E5%90%A6%20--%3E%20N%5B%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E7%B4%A2%E5%BC%95%5D%0A%20%20%20%20%20%20C%20--%3E%20O%5B%E7%BB%93%E6%9D%9F%5D%0A%20%20%20%20%20%20M%20--%3E%20O%0A%20%20%20%20%20%20N%20--%3E%20O%0A"})]),fallback:n(()=>[...s[0]||(s[0]=[k(" Loading... ",-1)])]),_:1})),s[2]||(s[2]=a(`<p><strong>识别优先级：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>bat_model_get_index() {</span></span>
<span class="line"><span>    1. 尝试通过序列号识别 (bat_model_get_index_by_type)</span></span>
<span class="line"><span>       └─&gt; get_battery_type() 获取电池序列号</span></span>
<span class="line"><span>       └─&gt; 匹配 sn_type 字段</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    2. 尝试通过高通 FG 电压识别 (is_qcom_fg)</span></span>
<span class="line"><span>       └─&gt; power_platform_get_index_by_volt()</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    3. 尝试通过 IIO 通道识别 (support_iio)</span></span>
<span class="line"><span>       └─&gt; iio_read_channel_processed(id_iio, &amp;id_volt)</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    4. 尝试通过 ADC 通道识别 (id_adc_channel)</span></span>
<span class="line"><span>       └─&gt; power_platform_get_adc_voltage()</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    5. 使用默认索引 (失败情况)</span></span>
<span class="line"><span>       └─&gt; 上报 DSM 异常</span></span>
<span class="line"><span>}</span></span></code></pre></div><p><strong>核心代码：</strong></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_get_index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_model_device </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">di</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 优先通过序列号识别</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_model_get_index_by_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // QCOM FG 方式</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (di-&gt;is_qcom_fg)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">power_platform_get_index_by_volt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id_volt) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            goto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> search_table;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // IIO 方式</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_model_get_index_by_iio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id_volt) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        goto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> search_table;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ADC 方式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    id_volt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> power_platform_get_adc_voltage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di-&gt;id_adc_channel);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">search_table:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 在 ID 表中查找匹配的电压区间</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di-&gt;table_size; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((id_volt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di-&gt;tables[i].id_vol_low) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            (id_volt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> di-&gt;tables[i].id_vol_high)) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            bat_model_set_brand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di, i);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use_default:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bat_model_set_brand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di, di-&gt;default_index);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    bat_model_report_dsm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(id_volt);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 上报异常</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_4-2-品牌信息解析算法" tabindex="-1">4.2 品牌信息解析算法 <a class="header-anchor" href="#_4-2-品牌信息解析算法" aria-label="Permalink to &quot;4.2 品牌信息解析算法&quot;">​</a></h3><ol><li>从型号名称中提取品牌部分（第一个&quot;_&quot;前的内容）</li><li>解析FCC值（第二个&quot;_&quot;后的数字）</li><li>解析最大电压（第三个&quot;_&quot;后的数字，可选）</li><li>存储到设备数据结构中</li></ol><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_model_set_brand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(di, index) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 型号格式: &quot;品牌_容量_电压_后缀&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 示例: &quot;SUNWODA_4800_4480_S&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 提取品牌 (第1段)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       SUNWODA → di-&gt;brand </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;SUNWODA&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    2.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 提取容量 (第2段)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       4800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> → di-&gt;fcc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mAh</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    3.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 提取最大电压 (第3段)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       4480</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> → di-&gt;vbat_max </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4480</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mV</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>示例： 型号名称: &quot;SUNWODA_4800_4480&quot; 解析结果:</p><ul><li>brand = &quot;SUNWODA&quot;</li><li>fcc = 4800 mAh</li><li>vbat_max = 4480 mV</li><li>id_index = 匹配的索引</li></ul><h3 id="_4-3-电池类型匹配算法" tabindex="-1">4.3 电池类型匹配算法 <a class="header-anchor" href="#_4-3-电池类型匹配算法" aria-label="Permalink to &quot;4.3 电池类型匹配算法&quot;">​</a></h3><p>// 类型匹配流程（battery_model.c:193-227）</p><ol><li>遍历电池类型表</li><li>查找匹配的类型字符串</li><li>获取对应的标识符模式</li><li>使用正则表达式匹配标识符</li><li>返回匹配结果</li></ol><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_model_get_bat_cathode_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 检查是否启用阴极扩展 (bat_cathode_ext)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       └─</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 未启用 → 默认返回石墨基</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    2.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 匹配硅基电池</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       └─</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_match_silicon_battery</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">           └─</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 读取电池标识符 (get_battery_identifier)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">           └─</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 正则匹配 bat_types_tab</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.identifier_pattern</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">           └─</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 匹配成功 → 硅基电池</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    3.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 默认石墨基电池</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>DTS配置示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>bat_types_pattern = &lt;</span></span>
<span class="line"><span>    &quot;silicon&quot;   &quot;^SI.*&quot;</span><span>      // 硅基电池：标识符以 SI 开头</span></span>
<span class="line"><span>    &quot;graphite&quot;  &quot;^GR.*&quot;</span><span>      // 石墨基电池：标识符以 GR 开头</span></span>
<span class="line"><span>&gt;;</span></span></code></pre></div><p>电池识别示例: <strong>场景 1：通过序列号识别</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>DTS 配置:</span></span>
<span class="line"><span>  bat_id_table = &lt;&quot;SUNWODA_4800_4480&quot; ... &quot;004S&quot;&gt;;</span></span>
<span class="line"><span>  bat_cathode_ext = &lt;1&gt;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>识别流程:</span></span>
<span class="line"><span>  1. get_battery_type() → &quot;004&quot;</span></span>
<span class="line"><span>  2. bat_model_get_bat_cathode_type() → SILICON (硅基)</span></span>
<span class="line"><span>  3. 追加后缀 → &quot;004S&quot;</span></span>
<span class="line"><span>  4. 匹配成功 → index = 对应索引</span></span>
<span class="line"><span>  5. 解析品牌 → brand = &quot;SUNWODA&quot;, fcc = 4800</span></span></code></pre></div><p><strong>场景 2：通过 IIO 电压识别</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>DTS 配置:</span></span>
<span class="line"><span>  bat_id_table = &lt;&quot;DESAY_4800_4480&quot; 200000 400000 &quot;005&quot;&gt;;</span></span>
<span class="line"><span>  support_iio = &lt;1&gt;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>识别流程:</span></span>
<span class="line"><span>  1. iio_read_channel_processed() → 300000 μV (300mV)</span></span>
<span class="line"><span>  2. 查找电压区间 → 200000 ≤ 300000 &lt; 400000</span></span>
<span class="line"><span>  3. 匹配成功 → tables[1]</span></span>
<span class="line"><span>  4. 解析品牌 → brand = &quot;DESAY&quot;, fcc = 4800</span></span></code></pre></div><p><strong>场景 3：ADC 识别失败，使用默认值</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>识别流程:</span></span>
<span class="line"><span>  1. 所有识别方式失败</span></span>
<span class="line"><span>  2. 使用 default_id_index = 0</span></span>
<span class="line"><span>  3. brand = &quot;Battery&quot; (默认)</span></span>
<span class="line"><span>  4. 上报 DSM 异常</span></span></code></pre></div><h2 id="五、配置选项" tabindex="-1">五、配置选项 <a class="header-anchor" href="#五、配置选项" aria-label="Permalink to &quot;五、配置选项&quot;">​</a></h2><h3 id="_5-1-kconfig配置" tabindex="-1">5.1 Kconfig配置 <a class="header-anchor" href="#_5-1-kconfig配置" aria-label="Permalink to &quot;5.1 Kconfig配置&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>  config HUAWEI_BATTERY_MODEL</span></span>
<span class="line"><span>      bool &quot;huawei battery model driver&quot;</span></span>
<span class="line"><span>      default n</span></span>
<span class="line"><span>      help</span></span>
<span class="line"><span>        Say Y here to enable battery model driver.</span></span>
<span class="line"><span>        This driver provides a unified interface to battery model,</span></span>
<span class="line"><span>        such as: battery name, rated capacity, etc.</span></span>
<span class="line"><span>        It shields battery model differences between platforms.</span></span></code></pre></div><h3 id="_5-2-设备树配置参数" tabindex="-1">5.2 设备树配置参数 <a class="header-anchor" href="#_5-2-设备树配置参数" aria-label="Permalink to &quot;5.2 设备树配置参数&quot;">​</a></h3><p>模块从设备树中读取以下配置参数：</p><table tabindex="0"><thead><tr><th>参数</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>bat_id_table</td><td>电池型号表（名称、电压范围、SN类型）</td><td>-</td></tr><tr><td>si_item_code</td><td>SI项目代码表</td><td>-</td></tr><tr><td>bat_types_pattern</td><td>电池类型与标识符模式映射表</td><td>-</td></tr><tr><td>bat_cathode_ext</td><td>阴极扩展标志</td><td>0</td></tr><tr><td>bat_num</td><td>电池数量</td><td>1</td></tr><tr><td>design_fcc</td><td>设计满充容量</td><td>BAT_MODEL_INVALID_FCC</td></tr><tr><td>id_adc_channel</td><td>ADC通道号</td><td>BAT_MODEL_INVALID_CHANNEL</td></tr><tr><td>default_id_index</td><td>默认索引</td><td>BAT_MODEL_DEFAULT_INDEX</td></tr><tr><td>technology</td><td>技术类型</td><td>POWER_SUPPLY_DEFAULT_TECHNOLOGY</td></tr><tr><td>bat_identifier_index</td><td>标识符索引</td><td>BAT_IDENTIFIER_INDEX (10)</td></tr><tr><td>bat_identifier_len</td><td>标识符长度</td><td>BAT_IDENTIFIER_LEN (1)</td></tr><tr><td>is_qcom_fg</td><td>高通电量计标志</td><td>0</td></tr><tr><td>support_iio</td><td>IIO支持标志</td><td>0</td></tr></tbody></table><p>设备树中的关键参数</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_model {</span></span>
<span class="line"><span>    compatible = &quot;huawei,battery_model&quot;;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 电池 ID 映射表 (4 列: 型号名, 电压下限, 电压上限, 序列号类型) */</span></span>
<span class="line"><span>    bat_id_table = &lt;</span></span>
<span class="line"><span>        &quot;SUNWODA_4800_4480&quot; 0     200000  &quot;004&quot;</span><span>   // ID 电压 0-200mV</span></span>
<span class="line"><span>        &quot;DESAY_4800_4480&quot;   200000 400000 &quot;005&quot;</span><span>   // ID 电压 200-400mV</span></span>
<span class="line"><span>        &quot;ATL_4800_4480&quot;     400000 600000 &quot;006&quot;</span><span>   // ID 电压 400-600mV</span></span>
<span class="line"><span>    &gt;;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* SI 项目码 */</span></span>
<span class="line"><span>    si_item_code = &lt;&quot;1234&quot;&gt;;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 电池类型正则表 (2 列: 类型名, 正则模式) */</span></span>
<span class="line"><span>    bat_types_pattern = &lt;</span></span>
<span class="line"><span>        &quot;silicon&quot;   &quot;^SI.*&quot;</span><span>    // 硅基电池</span></span>
<span class="line"><span>        &quot;graphite&quot;  &quot;^GR.*&quot;</span><span>    // 石墨基电池</span></span>
<span class="line"><span>    &gt;;</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 基础配置 */</span></span>
<span class="line"><span>    bat_num = &lt;1&gt;;                    // 电池数量</span></span>
<span class="line"><span>    bat_cathode_ext = &lt;1&gt;;            // 启用阴极扩展识别</span></span>
<span class="line"><span>    design_fcc = &lt;4800000&gt;;           // 设计容量 (μAh)</span></span>
<span class="line"><span>    id_adc_channel = &lt;5&gt;;             // ADC 通道号</span></span>
<span class="line"><span>    default_id_index = &lt;0&gt;;           // 默认索引</span></span>
<span class="line"><span>    technology = &lt;1&gt;;                 // POWER_SUPPLY_TECHNOLOGY_LION</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 标识符配置 */</span></span>
<span class="line"><span>    bat_identifier_index = &lt;10&gt;;      // 标识符起始位置</span></span>
<span class="line"><span>    bat_identifier_len = &lt;1&gt;;         // 标识符长度</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    /* 平台相关 */</span></span>
<span class="line"><span>    is_qcom_fg = &lt;0&gt;;                 // 是否高通 FG 平台</span></span>
<span class="line"><span>    support_iio = &lt;1&gt;;                // 是否支持 IIO 读取</span></span>
<span class="line"><span>};</span></span></code></pre></div><h2 id="六、与其他模块的交互关系" tabindex="-1">六、与其他模块的交互关系 <a class="header-anchor" href="#六、与其他模块的交互关系" aria-label="Permalink to &quot;六、与其他模块的交互关系&quot;">​</a></h2><h3 id="_6-1-上游依赖模块" tabindex="-1">6.1 上游依赖模块 <a class="header-anchor" href="#_6-1-上游依赖模块" aria-label="Permalink to &quot;6.1 上游依赖模块&quot;">​</a></h3><table tabindex="0"><thead><tr><th>模块</th><th>交互方式</th><th>功能</th></tr></thead><tbody><tr><td>power_platform</td><td>函数调用</td><td>获取ADC电压、高通平台电压</td></tr><tr><td>IIO子系统</td><td>IIO通道</td><td>读取电池ID电压</td></tr><tr><td>power_dts</td><td>设备树解析</td><td>加载配置参数</td></tr><tr><td>power_dsm</td><td>事件报告</td><td>电池识别失败诊断</td></tr></tbody></table><h3 id="_6-2-下游服务模块" tabindex="-1">6.2 下游服务模块 <a class="header-anchor" href="#_6-2-下游服务模块" aria-label="Permalink to &quot;6.2 下游服务模块&quot;">​</a></h3><table tabindex="0"><thead><tr><th>模块</th><th>交互方式</th><th>功能</th></tr></thead><tbody><tr><td>battery_core</td><td>函数调用</td><td>提供电池型号、参数、品牌信息</td></tr><tr><td>power_supply</td><td>接口注册</td><td>电池属性查询接口</td></tr><tr><td>电池健康评估</td><td>数据查询</td><td>电池老化参数基准</td></tr></tbody></table><h3 id="_6-3-关键交互接口" tabindex="-1">6.3 关键交互接口 <a class="header-anchor" href="#_6-3-关键交互接口" aria-label="Permalink to &quot;6.3 关键交互接口&quot;">​</a></h3><h4 id="_6-3-1-与battery-core的交互" tabindex="-1">6.3.1 与battery_core的交互 <a class="header-anchor" href="#_6-3-1-与battery-core的交互" aria-label="Permalink to &quot;6.3.1 与battery_core的交互&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // battery_core通过以下函数获取电池模型信息：</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_get_vbat_max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 获取最大电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_get_design_fcc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 获取设计FCC</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_get_technology</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 获取技术类型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_model_get_brand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // 获取品牌信息</span></span></code></pre></div><h4 id="_6-3-2-与power-platform的交互" tabindex="-1">6.3.2 与power_platform的交互 <a class="header-anchor" href="#_6-3-2-与power-platform的交互" aria-label="Permalink to &quot;6.3.2 与power_platform的交互&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 获取ADC电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> power_platform_get_adc_voltage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 高通平台获取电压</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> power_platform_get_index_by_volt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">volt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="_6-3-3-与power-dsm的交互" tabindex="-1">6.3.3 与power_dsm的交互 <a class="header-anchor" href="#_6-3-3-与power-dsm的交互" aria-label="Permalink to &quot;6.3.3 与power_dsm的交互&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 电池识别失败诊断报告</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_report_dsm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> id_vol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> buf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 工厂模式不上报</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">power_cmdline_is_factory_mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    get_battery_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type, BAT_MODEL_TYPE_LEN);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    snprintf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buf, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buf) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;batt type=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, id_vol=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, type, id_vol);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 上报 DSM (Device State Monitor)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    power_dsm_report_dmd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(POWER_DSM_BATTERY_DETECT,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        POWER_DSM_BATTERY_DETECT_ERROR_NO, buf);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="七、导出接口api" tabindex="-1">七、导出接口API <a class="header-anchor" href="#七、导出接口api" aria-label="Permalink to &quot;七、导出接口API&quot;">​</a></h2><h3 id="_7-1-获取电池参数" tabindex="-1">7.1 获取电池参数 <a class="header-anchor" href="#_7-1-获取电池参数" aria-label="Permalink to &quot;7.1 获取电池参数&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 获取最大电压 (mV)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_get_vbat_max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 获取设计容量 (mAh)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_get_design_fcc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 获取电池技术类型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_get_technology</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 检查电池是否移除</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_is_removed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 获取电池品牌</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_model_get_brand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 获取电池型号名称</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bat_model_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 获取电池阴极类型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_get_bat_cathode_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="_7-2-操作回调注册" tabindex="-1">7.2 操作回调注册 <a class="header-anchor" href="#_7-2-操作回调注册" aria-label="Permalink to &quot;7.2 操作回调注册&quot;">​</a></h3><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_model_ops {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">get_vbat_max)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">get_design_fcc)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">get_technology)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">is_removed)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">get_brand)(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dev_data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bat_model_register_ops</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_model_ops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ops</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h2 id="八、sysfs调试接口" tabindex="-1">八、sysfs调试接口 <a class="header-anchor" href="#八、sysfs调试接口" aria-label="Permalink to &quot;八、sysfs调试接口&quot;">​</a></h2><p>节点路径：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>/sys/class/hw_power/battery/battery_model/</span></span>
<span class="line"><span>├── bat_cathode_type  (R) - 电池阴极类型 (0=石墨, 1=硅)</span></span></code></pre></div><p>Debug 节点（需 CONFIG_POWER_DEBUG）：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>/sys/kernel/debug/power/bat_model/</span></span>
<span class="line"><span>├── id          (R) - 电池 ID 索引</span></span>
<span class="line"><span>├── name        (R) - 电池型号名称</span></span>
<span class="line"><span>├── brand       (R) - 电池品牌</span></span>
<span class="line"><span>├── vbat_max    (R) - 最大电压</span></span>
<span class="line"><span>├── rated_fcc   (R) - 额定容量</span></span></code></pre></div><p>关键日志点： battery type is ... - 序列号类型 id vol is ... - ID 电压读数 index=X,fcc=X,vbat_max=X,brand=X - 识别结果</p><h2 id="九、初始化流程" tabindex="-1">九、初始化流程 <a class="header-anchor" href="#九、初始化流程" aria-label="Permalink to &quot;九、初始化流程&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>bat_model_probe()</span></span>
<span class="line"><span>├── 1. 分配设备结构体 (kzalloc)</span></span>
<span class="line"><span>├── 2. 初始化默认数据</span></span>
<span class="line"><span>│   ├── vbat_max = 4400 mV</span></span>
<span class="line"><span>│   ├── fcc = 3000 mAh</span></span>
<span class="line"><span>│   ├── brand = &quot;Battery&quot;</span></span>
<span class="line"><span>│   └── id_index = -1 (未识别)</span></span>
<span class="line"><span>├── 3. 解析 DTS 配置</span></span>
<span class="line"><span>│   ├── bat_id_table (ID 映射表)</span></span>
<span class="line"><span>│   ├── si_item_code (SI 码)</span></span>
<span class="line"><span>│   ├── bat_types_pattern (类型正则)</span></span>
<span class="line"><span>│   └── IIO 通道初始化</span></span>
<span class="line"><span>├── 4. 创建 Sysfs 节点</span></span>
<span class="line"><span>├── 5. 注册 Debug 接口</span></span>
<span class="line"><span>└── 6. 设置全局指针 g_bat_model_dev</span></span></code></pre></div><h2 id="十、模块依赖" tabindex="-1">十、模块依赖 <a class="header-anchor" href="#十、模块依赖" aria-label="Permalink to &quot;十、模块依赖&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>battery_model.c</span></span>
<span class="line"><span>├── get_battery_type()          (batt_info_pub.h)</span></span>
<span class="line"><span>├── get_battery_identifier()    (batt_info_pub.h)</span></span>
<span class="line"><span>├── power_platform_get_adc_voltage()</span></span>
<span class="line"><span>├── power_regex_lite_is_matched()</span></span>
<span class="line"><span>├── iio_channel_get()           (Linux IIO 框架)</span></span>
<span class="line"><span>└── power_dsm_report_dmd()      (DSM 异常上报)</span></span></code></pre></div><h2 id="十一、典型应用场景" tabindex="-1">十一、典型应用场景 <a class="header-anchor" href="#十一、典型应用场景" aria-label="Permalink to &quot;十一、典型应用场景&quot;">​</a></h2><ol><li>系统启动时识别电池型号 <ul><li>影响充电曲线选择</li><li>影响电池健康度算法</li><li>影响 UI 容量显示</li><li>电池更换检测</li></ul></li><li>识别新电池型号 <ul><li>触发 FCC 重新学习</li><li>更新电池品牌信息</li></ul></li><li>售后诊断 <ul><li>读取电池 ID 信息</li><li>检查电池是否为原装</li></ul></li></ol><p>battery_model模块是华为在电池管理领域技术积累的集中体现，通过精心的架构设计和算法优化，为移动设备提供了高性能、高可靠性、高安全性的电池模型管理解决方案。</p>`,59))])}const F=l(E,[["render",g]]);export{D as __pageData,F as default};
