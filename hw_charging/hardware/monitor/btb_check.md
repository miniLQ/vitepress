---
outline: deep
---

# BTB Check æ¨¡å—åˆ†æ

## 1. æ¨¡å—å®šä½ä¸æ ¸å¿ƒä»·å€¼

btb_check æ˜¯åä¸ºå……ç”µç®¡ç†ç³»ç»Ÿä¸­çš„ **BTBï¼ˆBattery To Boardï¼Œç”µæ± åˆ°ä¸»æ¿ï¼‰è¿æ¥å™¨å¼‚å¸¸ç›‘æµ‹æ¨¡å—**ï¼Œç”¨äºç›‘æµ‹ç”µæ± ä¸ä¸»æ¿ä¹‹é—´è¿æ¥å™¨çš„ç”µå‹å’Œæ¸©åº¦ï¼ŒåŠæ—¶å‘ç°æ¥è§¦ä¸è‰¯ç­‰ç¡¬ä»¶æ•…éšœã€‚

**æ ¸å¿ƒä»·å€¼ï¼š**
- ğŸ”Œ **è¿æ¥å™¨ç›‘æµ‹**ï¼šå®æ—¶ç›‘æµ‹ BTB è¿æ¥å™¨çš„ç”µå‹å’Œæ¸©åº¦
- ğŸ›¡ï¸ **åŒè·¯æ£€æµ‹**ï¼šæ”¯æŒä¸»ç”µæ± å’Œè¾…åŠ©ç”µæ± åŒ BTB æ£€æµ‹
- ğŸ“Š **å·®å¼‚æ£€æµ‹**ï¼šæ£€æµ‹åŒç”µæ±  BTB ä¹‹é—´çš„ç”µå‹/æ¸©åº¦å·®å¼‚
- âš ï¸ **æ•…éšœé¢„è­¦**ï¼šåŠæ—¶å‘ç°æ¥è§¦ä¸è‰¯ã€è™šæ¥ç­‰ç¡¬ä»¶é—®é¢˜

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è°ƒç”¨å±‚ (ç›´å……/å……ç”µæ¨¡å—)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ API
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                         â”‚
          â–¼                         â–¼
   btb_ck_get_result()      btb_ck_get_result_now()
   (è·å–æ£€æµ‹ç»“æœ)           (ç«‹å³æ£€æµ‹å¹¶è¿”å›)
          â”‚                         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  btb_check.c (æ ¸å¿ƒé€»è¾‘)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç›‘æ§å·¥ä½œé˜Ÿåˆ— (å……ç”µå¯åŠ¨å 30ms)                                â”‚
â”‚ â”œâ”€ ç”µå‹æ£€æµ‹å·¥ä½œ (volt_ck_work)                               â”‚
â”‚ â”‚   â€¢ è¯»å–ä¸» BTB ç”µå‹                                        â”‚
â”‚ â”‚   â€¢ è¯»å–è¾…åŠ© BTB ç”µå‹ï¼ˆå¦‚æœé…ç½®ï¼‰                           â”‚
â”‚ â”‚   â€¢ æ£€æŸ¥å•è·¯é˜ˆå€¼ (min_th ~ max_th)                        â”‚
â”‚ â”‚   â€¢ æ£€æŸ¥åŒè·¯å·®å¼‚ (diff_th)                                â”‚
â”‚ â”‚                                                           â”‚
â”‚ â””â”€ æ¸©åº¦æ£€æµ‹å·¥ä½œ (temp_ck_work)                               â”‚
â”‚     â€¢ è¯»å–ä¸» BTB æ¸©åº¦                                        â”‚
â”‚     â€¢ è¯»å–è¾…åŠ© BTB æ¸©åº¦ï¼ˆå¦‚æœé…ç½®ï¼‰                           â”‚
â”‚     â€¢ æ£€æŸ¥å•è·¯é˜ˆå€¼ (min_th ~ max_th)                        â”‚
â”‚     â€¢ æ£€æŸ¥åŒè·¯å·®å¼‚ (diff_th)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DC Manager   â”‚ â”‚ Battery Temp â”‚ â”‚ Sysfs Node   â”‚
â”‚ (ç”µå‹è¯»å–)    â”‚ â”‚ (æ¸©åº¦è¯»å–)    â”‚ â”‚ (ç»“æœæŸ¥è¯¢)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ dcm_get_ic_  â”‚ â”‚ bat_temp_get â”‚ â”‚ volt_result  â”‚
â”‚ vbtb()       â”‚ â”‚ _rt_temp()   â”‚ â”‚ temp_result  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 BTB è¿æ¥å™¨åŸç†

**BTBï¼ˆBattery To Boardï¼‰ï¼š** ç”µæ± ä¸ä¸»æ¿ä¹‹é—´çš„è¿æ¥å™¨ï¼Œæ‰¿è½½å……æ”¾ç”µå¤§ç”µæµ

```
ç”µæ± åŒ… â”€â”€[BTB è¿æ¥å™¨]â”€â”€ ä¸»æ¿å……ç”µç”µè·¯
         â”‚
         â”œâ”€ VBAT æ­£æè§¦ç‚¹
         â”œâ”€ GND  è´Ÿæè§¦ç‚¹
         â””â”€ æ¸©åº¦æ£€æµ‹è§¦ç‚¹

æ•…éšœæ¨¡å¼ï¼š
â€¢ æ¥è§¦ä¸è‰¯ â†’ ç”µé˜»å¢å¤§ â†’ å‹é™å¢å¤§ â†’ æ¸©åº¦å‡é«˜
â€¢ æ¾åŠ¨è™šæ¥ â†’ é—´æ­‡æ€§æ–­å¼€ â†’ ç”µå‹å¼‚å¸¸
â€¢ è…èš€æ°§åŒ– â†’ é˜»æŠ—å¢åŠ  â†’ å‘çƒ­
```

**åŒç”µæ±  BTBï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸»æ¿                     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ ä¸» BTB             â”‚ è¾…åŠ© BTB
     â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»ç”µæ±     â”‚          â”‚ è¾…åŠ©ç”µæ±   â”‚
â”‚ (3000mAh) â”‚          â”‚ (2000mAh) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¦æ±‚ï¼šä¸¤è·¯ BTB ç”µå‹/æ¸©åº¦å·®å¼‚ < é˜ˆå€¼
```

## 3. æ ¸å¿ƒæ•°æ®ç»“æ„

### 3.1 æ£€æµ‹å‚æ•°ç»“æ„

```c
struct btb_ck_para {
    int enable;           // æ˜¯å¦ä½¿èƒ½æ£€æµ‹ï¼ˆ0=å…³é—­, 1=å¼€å¯ï¼‰
    int is_multi_btb;     // æ˜¯å¦åŒ BTBï¼ˆ0=å•è·¯, 1=åŒè·¯ï¼‰
    int min_th;           // æœ€å°é˜ˆå€¼ï¼ˆç”µå‹ mV / æ¸©åº¦ â„ƒï¼‰
    int max_th;           // æœ€å¤§é˜ˆå€¼ï¼ˆç”µå‹ mV / æ¸©åº¦ â„ƒï¼‰
    int diff_th;          // å·®å¼‚é˜ˆå€¼ï¼ˆåŒè·¯å·®å€¼é™åˆ¶ï¼‰
    int times;            // æ£€æµ‹æ¬¡æ•°ï¼ˆå¤šæ¬¡é‡‡æ ·ï¼‰
    int dmd_no;           // DMD ä¸ŠæŠ¥ç¼–å·
};
```

### 3.2 è®¾å¤‡ç»“æ„

```c
struct btb_ck_dev {
    struct device *dev;                    // è®¾å¤‡æŒ‡é’ˆ
    struct notifier_block nb;              // å……ç”µäº‹ä»¶é€šçŸ¥
    struct delayed_work volt_ck_work;      // ç”µå‹æ£€æµ‹å·¥ä½œé˜Ÿåˆ—
    struct delayed_work temp_ck_work;      // æ¸©åº¦æ£€æµ‹å·¥ä½œé˜Ÿåˆ—
    struct btb_ck_para volt_ck_para;       // ç”µå‹æ£€æµ‹å‚æ•°
    struct btb_ck_para temp_ck_para;       // æ¸©åº¦æ£€æµ‹å‚æ•°
    unsigned int volt_ck_result;           // ç”µå‹æ£€æµ‹ç»“æœï¼ˆä½æ©ç ï¼‰
    unsigned int temp_ck_result;           // æ¸©åº¦æ£€æµ‹ç»“æœï¼ˆä½æ©ç ï¼‰
};
```

### 3.3 æ£€æµ‹ç»“æœæ ‡å¿—

```c
#define MAIN_BAT_BTB_ERR     BIT(0)   // ä¸»ç”µæ±  BTB å¼‚å¸¸
#define AUX_BAT_BTB_ERR      BIT(1)   // è¾…åŠ©ç”µæ±  BTB å¼‚å¸¸
#define BTB_BAT_DIFF_ERR     BIT(2)   // åŒç”µæ±  BTB å·®å¼‚è¿‡å¤§

/* ç»“æœä½æ©ç ç¤ºä¾‹ */
result = 0;                    // æ­£å¸¸
result = MAIN_BAT_BTB_ERR;     // 0x01: ä¸» BTB å¼‚å¸¸
result = AUX_BAT_BTB_ERR;      // 0x02: è¾…åŠ© BTB å¼‚å¸¸
result = BTB_BAT_DIFF_ERR;     // 0x04: å·®å¼‚å¼‚å¸¸
result = 0x07;                 // æ‰€æœ‰å¼‚å¸¸
```

### 3.4 æ£€æµ‹ç±»å‹

```c
enum btb_ck_type {
    BTB_VOLT_CHECK,   // ç”µå‹æ£€æµ‹
    BTB_TEMP_CHECK,   // æ¸©åº¦æ£€æµ‹
};
```

## 4. æ ¸å¿ƒæµç¨‹å®ç°

### 4.1 å®Œæ•´æ£€æµ‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å……ç”µå¯åŠ¨äº‹ä»¶                                              â”‚
â”‚    POWER_NE_CHARGING_START â†’ btb_ck_start()                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è°ƒåº¦æ£€æµ‹å·¥ä½œé˜Ÿåˆ—                                          â”‚
â”‚    å»¶è¿Ÿ 30ms â†’ schedule_delayed_work(volt_ck_work)           â”‚
â”‚    å»¶è¿Ÿ 30ms â†’ schedule_delayed_work(temp_ck_work)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ç”µå‹æ£€æµ‹ (btb_ck_volt_work)                               â”‚
â”‚    â‘  è¯»å–ä¸» BTB ç”µå‹ (dcm_get_ic_vbtb)                      â”‚
â”‚    â‘¡ æ£€æŸ¥ä¸» BTB: min_th â‰¤ vbtb â‰¤ max_th                    â”‚
â”‚    â‘¢ å¦‚æœåŒè·¯ï¼šè¯»å–è¾…åŠ© BTB ç”µå‹                             â”‚
â”‚    â‘£ æ£€æŸ¥è¾…åŠ© BTB: min_th â‰¤ vbtb â‰¤ max_th                  â”‚
â”‚    â‘¤ æ£€æŸ¥å·®å¼‚: |main - aux| â‰¤ diff_th                      â”‚
â”‚    â‘¥ å¤šæ¬¡é‡‡æ ·ï¼ˆé…ç½®çš„æ¬¡æ•°ï¼‰ï¼Œé—´éš” 30ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ¸©åº¦æ£€æµ‹ (btb_ck_temp_work)                               â”‚
â”‚    â‘  è¯»å–ä¸» BTB æ¸©åº¦ (bat_temp_get_rt_temperature)          â”‚
â”‚    â‘¡ æ£€æŸ¥ä¸» BTB: min_th â‰¤ temp â‰¤ max_th                    â”‚
â”‚    â‘¢ å¦‚æœåŒè·¯ï¼šè¯»å–è¾…åŠ© BTB æ¸©åº¦                             â”‚
â”‚    â‘£ æ£€æŸ¥è¾…åŠ© BTB: min_th â‰¤ temp â‰¤ max_th                  â”‚
â”‚    â‘¤ æ£€æŸ¥å·®å¼‚: |main - aux| â‰¤ diff_th                      â”‚
â”‚    â‘¥ å¤šæ¬¡é‡‡æ ·ï¼ˆé…ç½®çš„æ¬¡æ•°ï¼‰ï¼Œé—´éš” 30ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ç»“æœå­˜å‚¨                                                  â”‚
â”‚    volt_ck_result = æ£€æµ‹ç»“æœä½æ©ç                            â”‚
â”‚    temp_ck_result = æ£€æµ‹ç»“æœä½æ©ç                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ä¸Šå±‚æŸ¥è¯¢ç»“æœ                                              â”‚
â”‚    btb_ck_get_result(BTB_VOLT_CHECK) â†’ volt_ck_result       â”‚
â”‚    btb_ck_get_result(BTB_TEMP_CHECK) â†’ temp_ck_result       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç”µå‹æ£€æµ‹è¯¦è§£

```c
static void btb_ck_bat_volt(struct btb_ck_para *data, unsigned int *result)
{
    int main_btb;
    int aux_btb;
    int btb_diff;

    if (data->enable == 0)
        return;

    /* æ­¥éª¤ 1: è¯»å–ä¸» BTB ç”µå‹ */
    main_btb = dcm_get_ic_vbtb(SC_MODE, CHARGE_IC_MAIN);
    
    /* æ­¥éª¤ 2: æ£€æŸ¥ä¸» BTB ç”µå‹èŒƒå›´ */
    if ((main_btb < 0) ||                   // è¯»å–å¤±è´¥
        (main_btb > data->max_th) ||        // è¶…è¿‡ä¸Šé™
        (main_btb < data->min_th))          // ä½äºä¸‹é™
        *result |= MAIN_BAT_BTB_ERR;
    
    hwlog_info("main btb voltage=%dmV\n", main_btb);
    
    /* æ­¥éª¤ 3: å¦‚æœæ˜¯åŒ BTB é…ç½® */
    if (data->is_multi_btb) {
        /* è¯»å–è¾…åŠ© BTB ç”µå‹ */
        aux_btb = dcm_get_ic_vbtb(SC_MODE, CHARGE_IC_AUX);
        
        /* è®¡ç®—ç”µå‹å·®å¼‚ï¼ˆç»å¯¹å€¼ï¼‰*/
        btb_diff = main_btb - aux_btb;
        btb_diff = btb_diff > 0 ? btb_diff : -btb_diff;
        
        /* æ£€æŸ¥è¾…åŠ© BTB ç”µå‹èŒƒå›´ */
        if ((aux_btb < 0) ||
            (aux_btb > data->max_th) ||
            (aux_btb < data->min_th))
            *result |= AUX_BAT_BTB_ERR;
        
        /* æ£€æŸ¥åŒè·¯å·®å¼‚ */
        if (btb_diff > data->diff_th)
            *result |= BTB_BAT_DIFF_ERR;
        
        hwlog_info("aux btb voltage=%dmV, btb_diff=%dmV\n",
            aux_btb, btb_diff);
    }
}
```

**ç”µå‹æ£€æµ‹é€»è¾‘ï¼š**

| æ£€æŸ¥é¡¹ | æ¡ä»¶ | é”™è¯¯æ ‡å¿— |
|-------|------|---------|
| ä¸» BTB èŒƒå›´ | main_btb < min_th æˆ– > max_th | MAIN_BAT_BTB_ERR |
| è¾…åŠ© BTB èŒƒå›´ | aux_btb < min_th æˆ– > max_th | AUX_BAT_BTB_ERR |
| åŒè·¯å·®å¼‚ | \|main - aux\| > diff_th | BTB_BAT_DIFF_ERR |

**å¤šæ¬¡é‡‡æ ·æœºåˆ¶ï¼š**

```c
static void btb_ck_bat_volt_by_multi_times(struct btb_ck_para *data,
    unsigned int *result)
{
    int i;

    // å¤šæ¬¡é‡‡æ ·ï¼Œåªè¦æœ‰ä¸€æ¬¡å¼‚å¸¸å°±è¿”å›
    for (i = 0; i < data->times; i++) {
        btb_ck_bat_volt(data, result);
        if (*result)
            return;  // å‘ç°å¼‚å¸¸ï¼Œç«‹å³è¿”å›
        
        /* å»¶è¿Ÿ 30msï¼Œç­‰å¾… ADC é‡‡æ ·é—´éš” */
        usleep_range(30000, 31000);
    }
}
```

**é‡‡æ ·ç­–ç•¥ï¼š**
- é…ç½®é‡‡æ ·æ¬¡æ•°ï¼ˆå¦‚ 3 æ¬¡ï¼‰
- æ¯æ¬¡é—´éš” 30msï¼ˆADC é‡‡æ ·å‘¨æœŸï¼‰
- **å¿«é€Ÿå¤±è´¥**ï¼šä»»æ„ä¸€æ¬¡å¼‚å¸¸ç«‹å³è¿”å›
- **å…¨éƒ¨æ­£å¸¸**ï¼šæ‰€æœ‰æ¬¡æ•°éƒ½é€šè¿‡æ‰è®¤ä¸ºæ­£å¸¸

### 4.3 æ¸©åº¦æ£€æµ‹è¯¦è§£

```c
static void btb_ck_bat_temp(struct btb_ck_para *data, unsigned int *result)
{
    int main_btb = 0;
    int aux_btb = 0;
    int btb_diff;
    int i;
    int ret;

    // å¤šæ¬¡é‡‡æ ·å¾ªç¯
    for (i = 0; i < data->times; i++) {
        /* æ­¥éª¤ 1: è¯»å–ä¸» BTB æ¸©åº¦ */
        ret = bat_temp_get_rt_temperature(BTB_TEMP_0, &main_btb);
        
        /* æ­¥éª¤ 2: æ£€æŸ¥ä¸» BTB æ¸©åº¦èŒƒå›´ */
        if ((ret < 0) ||
            (main_btb > data->max_th) ||
            (main_btb < data->min_th))
            *result |= MAIN_BAT_BTB_ERR;
        
        hwlog_info("main btb temp=%d\n", main_btb);
        
        /* æ­¥éª¤ 3: å¦‚æœæ˜¯åŒ BTB é…ç½® */
        if (data->is_multi_btb) {
            /* è¯»å–è¾…åŠ© BTB æ¸©åº¦ */
            ret = bat_temp_get_rt_temperature(BTB_TEMP_1, &aux_btb);
            
            /* æ£€æŸ¥è¾…åŠ© BTB æ¸©åº¦èŒƒå›´ */
            if ((ret < 0) ||
                (aux_btb > data->max_th) ||
                (aux_btb < data->min_th))
                *result |= AUX_BAT_BTB_ERR;
            
            /* è®¡ç®—æ¸©åº¦å·®å¼‚ */
            btb_diff = main_btb - aux_btb;
            btb_diff = btb_diff > 0 ? btb_diff : -btb_diff;
            
            /* æ£€æŸ¥åŒè·¯å·®å¼‚ */
            if (btb_diff > data->diff_th)
                *result |= BTB_BAT_DIFF_ERR;
            
            hwlog_info("aux btb temp=%d, btb_diff=%d\n",
                aux_btb, btb_diff);
        }
        
        // å‘ç°å¼‚å¸¸ç«‹å³è¿”å›
        if (*result)
            return;
        
        /* å»¶è¿Ÿ 30ms */
        usleep_range(30000, 31000);
    }
}
```

**æ¸©åº¦ä¼ æ„Ÿå™¨ä½ç½®ï¼š**

```
ç”µæ± åŒ…å†…éƒ¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [BTB è¿æ¥å™¨]                    â”‚
â”‚    â”œâ”€ æ­£æè§¦ç‚¹                   â”‚
â”‚    â”œâ”€ è´Ÿæè§¦ç‚¹                   â”‚
â”‚    â””â”€ æ¸©åº¦ä¼ æ„Ÿå™¨ (BTB_TEMP_0)    â”‚
â”‚                                  â”‚
â”‚  [è¾…åŠ© BTB è¿æ¥å™¨]ï¼ˆå¦‚æœæœ‰ï¼‰      â”‚
â”‚    â”œâ”€ æ­£æè§¦ç‚¹                   â”‚
â”‚    â”œâ”€ è´Ÿæè§¦ç‚¹                   â”‚
â”‚    â””â”€ æ¸©åº¦ä¼ æ„Ÿå™¨ (BTB_TEMP_1)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 ç«‹å³æ£€æµ‹æ¥å£

```c
void btb_ck_get_result_now(int type, unsigned int *result)
{
    struct btb_ck_dev *l_dev = btb_ck_get_dev();

    if (!l_dev || !result)
        return;

    switch (type) {
    case BTB_VOLT_CHECK:
        // ç«‹å³æ‰§è¡Œç”µå‹æ£€æµ‹ï¼ˆå•æ¬¡ï¼‰
        btb_ck_bat_volt(&l_dev->volt_ck_para, result);
        break;
    case BTB_TEMP_CHECK:
        // ç«‹å³æ‰§è¡Œæ¸©åº¦æ£€æµ‹ï¼ˆå¤šæ¬¡ï¼‰
        btb_ck_bat_temp(&l_dev->temp_ck_para, result);
        break;
    default:
        break;
    }
}
```

**ç”¨é€”ï¼š** ç›´å……æ¨¡å—æˆ–å…¶ä»–æ¨¡å—éœ€è¦ç«‹å³è·å– BTB çŠ¶æ€æ—¶è°ƒç”¨

## 5. äº‹ä»¶é€šçŸ¥å¤„ç†

### 5.1 å……ç”µäº‹ä»¶

```c
static int btb_ck_event_call(struct notifier_block *nb,
    unsigned long event, void *data)
{
    struct btb_ck_dev *l_dev = btb_ck_get_dev();

    switch (event) {
    case POWER_NE_CHARGING_STOP:
        btb_ck_stop(l_dev);      // å……ç”µåœæ­¢ï¼Œå–æ¶ˆæ£€æµ‹
        break;
    case POWER_NE_CHARGING_START:
        btb_ck_start(l_dev);     // å……ç”µå¯åŠ¨ï¼Œå¼€å§‹æ£€æµ‹
        break;
    }

    return NOTIFY_OK;
}
```

### 5.2 å¯åŠ¨/åœæ­¢æ£€æµ‹

```c
static void btb_ck_start(struct btb_ck_dev *l_dev)
{
    // å–æ¶ˆä¹‹å‰çš„å·¥ä½œï¼ˆå¦‚æœæœ‰ï¼‰
    cancel_delayed_work(&l_dev->volt_ck_work);
    cancel_delayed_work(&l_dev->temp_ck_work);
    
    // å»¶è¿Ÿ 30ms å¯åŠ¨ç”µå‹æ£€æµ‹
    schedule_delayed_work(&l_dev->volt_ck_work,
        msecs_to_jiffies(BTB_CK_WORK_DELAY_TIME));
    
    // å»¶è¿Ÿ 30ms å¯åŠ¨æ¸©åº¦æ£€æµ‹
    schedule_delayed_work(&l_dev->temp_ck_work,
        msecs_to_jiffies(BTB_CK_WORK_DELAY_TIME));
}

static void btb_ck_stop(struct btb_ck_dev *l_dev)
{
    // å–æ¶ˆæ‰€æœ‰æ£€æµ‹å·¥ä½œ
    cancel_delayed_work(&l_dev->volt_ck_work);
    cancel_delayed_work(&l_dev->temp_ck_work);
}
```

**æ—¶åºå›¾ï¼š**

```
å……ç”µå™¨æ’å…¥
    â”‚
    â–¼
POWER_NE_CHARGING_START
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–º volt_ck_work (30ms å)
    â”‚               â”‚
    â”‚               â”œâ”€ é‡‡æ · 1 (0ms)
    â”‚               â”œâ”€ é‡‡æ · 2 (30ms)
    â”‚               â””â”€ é‡‡æ · 3 (60ms)
    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º temp_ck_work (30ms å)
                    â”‚
                    â”œâ”€ é‡‡æ · 1 (0ms)
                    â”œâ”€ é‡‡æ · 2 (30ms)
                    â””â”€ é‡‡æ · 3 (60ms)
```

## 6. Sysfs æ¥å£

### 6.1 æ¥å£åˆ—è¡¨

```bash
# BTB æ£€æµ‹ sysfs èŠ‚ç‚¹è·¯å¾„
/sys/class/hw_power/btb_ck/
â”œâ”€â”€ volt_result   # åªè¯»ï¼Œç”µå‹æ£€æµ‹ç»“æœ
â””â”€â”€ temp_result   # åªè¯»ï¼Œæ¸©åº¦æ£€æµ‹ç»“æœ
```

### 6.2 æ¥å£è¯¦è§£

#### 6.2.1 volt_resultï¼ˆç”µå‹æ£€æµ‹ç»“æœï¼‰

**è¯»æ“ä½œï¼š**
```bash
cat /sys/class/hw_power/btb_ck/volt_result
```

**è¿”å›å€¼ï¼š**
- `0` - æ­£å¸¸
- `1` (0x01) - ä¸» BTB ç”µå‹å¼‚å¸¸
- `2` (0x02) - è¾…åŠ© BTB ç”µå‹å¼‚å¸¸
- `4` (0x04) - åŒ BTB ç”µå‹å·®å¼‚è¿‡å¤§
- `7` (0x07) - æ‰€æœ‰å¼‚å¸¸

#### 6.2.2 temp_resultï¼ˆæ¸©åº¦æ£€æµ‹ç»“æœï¼‰

**è¯»æ“ä½œï¼š**
```bash
cat /sys/class/hw_power/btb_ck/temp_result
```

**è¿”å›å€¼ï¼š** åŒ volt_result

### 6.3 ä½¿ç”¨ç¤ºä¾‹

**æ£€æŸ¥è„šæœ¬ï¼š**

```bash
#!/bin/bash

# è¯»å–æ£€æµ‹ç»“æœ
volt_result=$(cat /sys/class/hw_power/btb_ck/volt_result)
temp_result=$(cat /sys/class/hw_power/btb_ck/temp_result)

# è§£æç»“æœ
parse_result() {
    local result=$1
    local type=$2
    
    if [ $result -eq 0 ]; then
        echo "$type: PASS"
        return 0
    fi
    
    echo "$type: FAIL"
    [ $((result & 1)) -ne 0 ] && echo "  - ä¸» BTB å¼‚å¸¸"
    [ $((result & 2)) -ne 0 ] && echo "  - è¾…åŠ© BTB å¼‚å¸¸"
    [ $((result & 4)) -ne 0 ] && echo "  - åŒè·¯å·®å¼‚è¿‡å¤§"
    
    return 1
}

parse_result $volt_result "ç”µå‹æ£€æµ‹"
parse_result $temp_result "æ¸©åº¦æ£€æµ‹"
```

## 7. å…¸å‹åº”ç”¨åœºæ™¯

### 7.1 ç›´å……å¯åŠ¨å‰æ£€æµ‹

**åœºæ™¯ï¼š** ç›´å……æ¨¡å—åœ¨å¯åŠ¨å¤§ç”µæµå……ç”µå‰æ£€æŸ¥ BTB çŠ¶æ€

```c
// ç›´å……æ¨¡å—ä»£ç 
int direct_charge_check_btb(void)
{
    unsigned int volt_result = 0;
    unsigned int temp_result = 0;
    
    // ç«‹å³æ£€æµ‹ BTB çŠ¶æ€
    btb_ck_get_result_now(BTB_VOLT_CHECK, &volt_result);
    btb_ck_get_result_now(BTB_TEMP_CHECK, &temp_result);
    
    // æ£€æŸ¥ç»“æœ
    if (volt_result != 0) {
        hwlog_err("btb voltage check fail: 0x%x\n", volt_result);
        return -EINVAL;
    }
    
    if (temp_result != 0) {
        hwlog_err("btb temp check fail: 0x%x\n", temp_result);
        return -EINVAL;
    }
    
    // BTB æ­£å¸¸ï¼Œå¯ä»¥å¯åŠ¨ç›´å……
    return 0;
}
```

### 7.2 å……ç”µè¿‡ç¨‹ç›‘æµ‹

**åœºæ™¯ï¼š** å……ç”µè¿‡ç¨‹ä¸­å‘¨æœŸæ€§æ£€æµ‹ BTB çŠ¶æ€

```bash
# å……ç”µå¯åŠ¨
POWER_NE_CHARGING_START â†’ btb_ck_start()

# 30ms åæ‰§è¡Œç”µå‹æ£€æµ‹
volt_ck_work:
  main_btb = dcm_get_ic_vbtb(MAIN) = 4150mV âœ“
  aux_btb  = dcm_get_ic_vbtb(AUX)  = 4148mV âœ“
  diff     = |4150 - 4148| = 2mV < 50mV âœ“
  result   = 0 (æ­£å¸¸)

# 30ms åæ‰§è¡Œæ¸©åº¦æ£€æµ‹
temp_ck_work:
  main_temp = bat_temp_get(BTB_TEMP_0) = 25â„ƒ âœ“
  aux_temp  = bat_temp_get(BTB_TEMP_1) = 26â„ƒ âœ“
  diff      = |25 - 26| = 1â„ƒ < 5â„ƒ âœ“
  result    = 0 (æ­£å¸¸)
```

### 7.3 BTB æ¥è§¦ä¸è‰¯æ£€æµ‹

**åœºæ™¯ï¼š** BTB æ¾åŠ¨å¯¼è‡´ç”µå‹å¼‚å¸¸

```bash
# æ£€æµ‹ç»“æœ
main_btb = 4150mV âœ“
aux_btb  = 3800mV âœ— (ä½äº min_th=4000mV)
result   = AUX_BAT_BTB_ERR (0x02)

# æ—¥å¿—è¾“å‡º
[btb_check] main btb voltage=4150mV
[btb_check] aux btb voltage=3800mV, btb_diff=350mV
[btb_check] btb check type is 0, result=2

# ç›´å……æ¨¡å—è¯»å–ç»“æœ
btb_ck_get_result(BTB_VOLT_CHECK) = 0x02
â†’ ç¦æ­¢å¯åŠ¨ç›´å……ï¼Œé¿å…å¤§ç”µæµæŸåè¿æ¥å™¨
```

### 7.4 åŒç”µæ± ä¸å‡è¡¡æ£€æµ‹

**åœºæ™¯ï¼š** åŒç”µæ±  BTB å·®å¼‚è¿‡å¤§

```bash
# æ£€æµ‹ç»“æœ
main_btb = 4200mV âœ“
aux_btb  = 4100mV âœ“
diff     = |4200 - 4100| = 100mV > diff_th=50mV âœ—
result   = BTB_BAT_DIFF_ERR (0x04)

# å¯èƒ½åŸå› ï¼š
# 1. ä¸»ç”µæ±  BTB æ¥è§¦ç”µé˜»å¢å¤§
# 2. è¾…åŠ©ç”µæ±  BTB æ¥è§¦ç”µé˜»å¢å¤§
# 3. åŒç”µæ± å®¹é‡å·®å¼‚å¤§ï¼Œå……ç”µä¸å‡è¡¡
```

## 8. DTS é…ç½®

### 8.1 é…ç½®ç¤ºä¾‹

```dts
btb_check {
    compatible = "huawei,btb_check";
    status = "ok";
    
    /* ç”µå‹æ£€æµ‹å‚æ•° */
    /* enable, is_multi_btb, min_th, max_th, diff_th, times, dmd_no */
    vol_check_para = <1>,      /* ä½¿èƒ½ç”µå‹æ£€æµ‹ */
                     <1>,      /* åŒ BTB é…ç½® */
                     <4000>,   /* æœ€å°ç”µå‹ 4000mV */
                     <4500>,   /* æœ€å¤§ç”µå‹ 4500mV */
                     <50>,     /* å·®å¼‚é˜ˆå€¼ 50mV */
                     <3>,      /* é‡‡æ · 3 æ¬¡ */
                     <920000>; /* DMD ç¼–å· */
    
    /* æ¸©åº¦æ£€æµ‹å‚æ•° */
    /* enable, is_multi_btb, min_th, max_th, diff_th, times, dmd_no */
    temp_check_para = <1>,     /* ä½¿èƒ½æ¸©åº¦æ£€æµ‹ */
                      <1>,     /* åŒ BTB é…ç½® */
                      <10>,    /* æœ€å°æ¸©åº¦ 10â„ƒ */
                      <60>,    /* æœ€å¤§æ¸©åº¦ 60â„ƒ */
                      <5>,     /* å·®å¼‚é˜ˆå€¼ 5â„ƒ */
                      <3>,     /* é‡‡æ · 3 æ¬¡ */
                      <920001>; /* DMD ç¼–å· */
};
```

### 8.2 å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | è¯´æ˜ | å…¸å‹å€¼ |
|-----|------|------|-------|
| enable | int | æ˜¯å¦ä½¿èƒ½æ£€æµ‹ | 1 (ä½¿èƒ½) |
| is_multi_btb | int | æ˜¯å¦åŒ BTB | 0 (å•è·¯) / 1 (åŒè·¯) |
| min_th | int | æœ€å°é˜ˆå€¼ | 4000mV / 10â„ƒ |
| max_th | int | æœ€å¤§é˜ˆå€¼ | 4500mV / 60â„ƒ |
| diff_th | int | å·®å¼‚é˜ˆå€¼ | 50mV / 5â„ƒ |
| times | int | é‡‡æ ·æ¬¡æ•° | 3 æ¬¡ |
| dmd_no | int | DMD ç¼–å· | 920000 |

### 8.3 é˜ˆå€¼è°ƒä¼˜å»ºè®®

**ç”µå‹é˜ˆå€¼ï¼š**

| å‚æ•° | æ¨èå€¼ | è°ƒä¼˜æ–¹å‘ | è¯´æ˜ |
|-----|-------|---------|------|
| min_th | 4000mV | æ ¹æ®ç”µæ± é¢å®šç”µå‹è°ƒæ•´ | è¿‡ä½å¯èƒ½é—æ¼æ•…éšœ |
| max_th | 4500mV | æ ¹æ®å……ç”µæœ€é«˜ç”µå‹è°ƒæ•´ | è¿‡é«˜å¯èƒ½è¯¯åˆ¤ |
| diff_th | 50mV | æ ¹æ®åŒç”µæ± é…ç½®è°ƒæ•´ | è¿‡å°å®¹æ˜“è¯¯è§¦å‘ |

**æ¸©åº¦é˜ˆå€¼ï¼š**

| å‚æ•° | æ¨èå€¼ | è°ƒä¼˜æ–¹å‘ | è¯´æ˜ |
|-----|-------|---------|------|
| min_th | 10â„ƒ | æ ¹æ®å·¥ä½œç¯å¢ƒè°ƒæ•´ | è¿‡ä½å¯èƒ½åœ¨ä½æ¸©ç¯å¢ƒè¯¯åˆ¤ |
| max_th | 60â„ƒ | æ ¹æ®å®‰å…¨è§„èŒƒè°ƒæ•´ | è¿‡é«˜å­˜åœ¨å®‰å…¨éšæ‚£ |
| diff_th | 5â„ƒ | æ ¹æ®æ•£çƒ­è®¾è®¡è°ƒæ•´ | è¿‡å°å®¹æ˜“è¯¯è§¦å‘ |

## 9. è°ƒè¯•æ–¹æ³•

### 9.1 æ—¥å¿—åˆ†æ

**ä½¿èƒ½åŠ¨æ€æ—¥å¿—ï¼š**

```bash
echo 'file btb_check.c +p' > /sys/kernel/debug/dynamic_debug/control
```

**å…³é”®æ—¥å¿—ï¼š**

```bash
# ç”µå‹æ£€æµ‹
[btb_check] main btb voltage=4150mV
[btb_check] aux btb voltage=4148mV, btb_diff=2mV
[btb_check] btb check type is 0, result=0

# æ¸©åº¦æ£€æµ‹
[btb_check] main btb temp=25
[btb_check] aux btb temp=26, btb_diff=1
[btb_check] btb check type is 1, result=0

# å¼‚å¸¸æƒ…å†µ
[btb_check] main btb voltage=4150mV
[btb_check] aux btb voltage=3800mV, btb_diff=350mV
[btb_check] btb check type is 0, result=2  â† AUX_BAT_BTB_ERR
```

### 9.2 Sysfs è°ƒè¯•

```bash
# æŸ¥çœ‹å½“å‰æ£€æµ‹ç»“æœ
cat /sys/class/hw_power/btb_ck/volt_result
cat /sys/class/hw_power/btb_ck/temp_result

# è§£æç»“æœ
result=$(cat /sys/class/hw_power/btb_ck/volt_result)
echo "Result: $result"
[ $((result & 1)) -ne 0 ] && echo "ä¸» BTB å¼‚å¸¸"
[ $((result & 2)) -ne 0 ] && echo "è¾…åŠ© BTB å¼‚å¸¸"
[ $((result & 4)) -ne 0 ] && echo "å·®å¼‚è¿‡å¤§"
```

### 9.3 æ•…éšœè¯Šæ–­æµç¨‹

```
é—®é¢˜ï¼šBTB æ£€æµ‹å¼‚å¸¸
  â”œâ”€ 1. æ£€æŸ¥é…ç½®æ˜¯å¦ä½¿èƒ½
  â”‚    â””â”€ DTS ä¸­ enable=1
  â”‚
  â”œâ”€ 2. æŸ¥çœ‹æ£€æµ‹ç»“æœ
  â”‚    â””â”€ cat /sys/class/hw_power/btb_ck/volt_result
  â”‚
  â”œâ”€ 3. åˆ†æå…·ä½“å¼‚å¸¸
  â”‚    â”œâ”€ bit0=1: ä¸» BTB ç”µå‹å¼‚å¸¸
  â”‚    â”‚    â””â”€ æ£€æŸ¥ä¸»ç”µæ± è¿æ¥å™¨æ˜¯å¦æ¾åŠ¨
  â”‚    â”œâ”€ bit1=1: è¾…åŠ© BTB ç”µå‹å¼‚å¸¸
  â”‚    â”‚    â””â”€ æ£€æŸ¥è¾…åŠ©ç”µæ± è¿æ¥å™¨æ˜¯å¦æ¾åŠ¨
  â”‚    â””â”€ bit2=1: åŒè·¯å·®å¼‚è¿‡å¤§
  â”‚         â””â”€ æ£€æŸ¥åŒç”µæ± æ˜¯å¦å®¹é‡ä¸åŒ¹é…
  â”‚
  â”œâ”€ 4. æ£€æŸ¥ç¡¬ä»¶
  â”‚    â”œâ”€ BTB è¿æ¥å™¨æ˜¯å¦æ¾åŠ¨
  â”‚    â”œâ”€ è§¦ç‚¹æ˜¯å¦æ°§åŒ–
  â”‚    â””â”€ å¼¹ç‰‡æ˜¯å¦å˜å½¢
  â”‚
  â””â”€ 5. è°ƒæ•´é˜ˆå€¼
       â””â”€ æ ¹æ®å®é™…æµ‹é‡å€¼è°ƒæ•´ DTS å‚æ•°
```

## 10. è®¾è®¡äº®ç‚¹

### 10.1 å¿«é€Ÿå¤±è´¥ç­–ç•¥

**é—®é¢˜ï¼š** å¤šæ¬¡é‡‡æ ·å¯èƒ½å»¶é•¿æ£€æµ‹æ—¶é—´

**è§£å†³æ–¹æ¡ˆï¼š** ä»»æ„ä¸€æ¬¡å¼‚å¸¸ç«‹å³è¿”å›

```c
for (i = 0; i < data->times; i++) {
    btb_ck_bat_volt(data, result);
    if (*result)
        return;  // å¿«é€Ÿå¤±è´¥
    usleep_range(30000, 31000);
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… å¿«é€Ÿå‘ç°æ•…éšœ
- âœ… é¿å…å»¶è¿Ÿç›´å……å¯åŠ¨
- âœ… å‡å°‘æ— æ•ˆé‡‡æ ·

### 10.2 åŒè·¯å·®å¼‚æ£€æµ‹

**é—®é¢˜ï¼š** åŒç”µæ± ç³»ç»Ÿå•è·¯æ£€æµ‹ä¸è¶³

**è§£å†³æ–¹æ¡ˆï¼š** å¢åŠ å·®å¼‚æ£€æµ‹

```c
btb_diff = main_btb - aux_btb;
btb_diff = btb_diff > 0 ? btb_diff : -btb_diff;  // ç»å¯¹å€¼
if (btb_diff > data->diff_th)
    *result |= BTB_BAT_DIFF_ERR;
```

**ä¼˜ç‚¹ï¼š**
- âœ… å‘ç°å•ä¾§æ¥è§¦ä¸è‰¯
- âœ… æ£€æµ‹ç”µæ± ä¸å‡è¡¡
- âœ… é¢„é˜²å……ç”µå€¾æ–œ

### 10.3 ç«‹å³æ£€æµ‹æ¥å£

**é—®é¢˜ï¼š** æŸäº›åœºæ™¯éœ€è¦å®æ—¶è·å– BTB çŠ¶æ€

**è§£å†³æ–¹æ¡ˆï¼š** æä¾›åŒæ­¥æ£€æµ‹æ¥å£

```c
void btb_ck_get_result_now(int type, unsigned int *result);
```

**ç”¨é€”ï¼š**
- ç›´å……å¯åŠ¨å‰æ£€æŸ¥
- å¼‚å¸¸æ¢å¤éªŒè¯
- äº§çº¿æµ‹è¯•

### 10.4 å»¶è¿Ÿå¯åŠ¨æ£€æµ‹

**é—®é¢˜ï¼š** å……ç”µå¯åŠ¨ç¬é—´ç”µå‹/æ¸©åº¦ä¸ç¨³å®š

**è§£å†³æ–¹æ¡ˆï¼š** å»¶è¿Ÿ 30ms åæ£€æµ‹

```c
schedule_delayed_work(&l_dev->volt_ck_work,
    msecs_to_jiffies(BTB_CK_WORK_DELAY_TIME));  // 30ms
```

**åŸå› ï¼š**
- å……ç”µå™¨æ¡æ‰‹éœ€è¦æ—¶é—´
- ç”µå‹éœ€è¦ç¨³å®š
- ADC éœ€è¦é‡‡æ ·å‘¨æœŸ

## 11. æ€»ç»“

btb_check æ¨¡å—æ˜¯åä¸ºå……ç”µç®¡ç†ç³»ç»Ÿä¸­çš„ **BTB è¿æ¥å™¨å¥åº·ç›‘æµ‹ç»„ä»¶**ï¼Œé€šè¿‡ä»¥ä¸‹è®¾è®¡å®ç°äº†å¯é çš„æ•…éšœæ£€æµ‹ï¼š

**æ ¸å¿ƒç‰¹æ€§ï¼š**
1. âœ… **åŒç»´åº¦æ£€æµ‹**ï¼šç”µå‹ + æ¸©åº¦åŒé‡ç›‘æµ‹
2. âœ… **åŒè·¯æ”¯æŒ**ï¼šä¸»ç”µæ±  + è¾…åŠ©ç”µæ± ç‹¬ç«‹æ£€æµ‹
3. âœ… **å·®å¼‚æ£€æµ‹**ï¼šåŒè·¯ BTB å·®å¼‚ç›‘æµ‹ï¼Œå‘ç°ä¸å‡è¡¡
4. âœ… **å¿«é€Ÿå¤±è´¥**ï¼šä»»æ„ä¸€æ¬¡å¼‚å¸¸ç«‹å³è¿”å›
5. âœ… **å¤šæ¬¡é‡‡æ ·**ï¼šæé«˜æ£€æµ‹å¯é æ€§

**åº”ç”¨ä»·å€¼ï¼š**
- ğŸ”Œ **é¢„é˜²æ•…éšœ**ï¼šå……ç”µå‰æ£€æµ‹ BTB çŠ¶æ€ï¼Œé¿å…å¤§ç”µæµæŸå
- ğŸ›¡ï¸ **å®‰å…¨ä¿æŠ¤**ï¼šåŠæ—¶å‘ç°æ¥è§¦ä¸è‰¯ï¼Œé˜²æ­¢è¿‡çƒ­èµ·ç«
- ğŸ“Š **è´¨é‡ç›‘æ§**ï¼šåŒç”µæ± ä¸å‡è¡¡æ£€æµ‹ï¼Œè¯„ä¼°ç”µæ± å¥åº·
- ğŸ”§ **å”®åè¯Šæ–­**ï¼šsysfs æ¥å£ä¾¿äºæ•…éšœå®šä½

**å…¸å‹åº”ç”¨ï¼š**
- âš¡ ç›´å……å¯åŠ¨å‰æ£€æŸ¥ BTB è¿æ¥å™¨çŠ¶æ€
- ğŸ”‹ å……ç”µè¿‡ç¨‹ä¸­ç›‘æµ‹ BTB æ¸©åº¦
- ğŸ“± åŒç”µæ± æ‰‹æœºä¸å‡è¡¡æ£€æµ‹
- ğŸ­ äº§çº¿ BTB è¿æ¥å™¨æµ‹è¯•

è¯¥æ¨¡å—å……åˆ†ä½“ç°äº† **é¢„é˜²æ€§æ£€æµ‹** å’Œ **å¤šé‡ä¿æŠ¤** çš„è®¾è®¡æ€æƒ³ï¼Œæ˜¯å¤§ç”µæµå……ç”µåœºæ™¯ä¸‹ç¡¬ä»¶å®‰å…¨ç›‘æµ‹çš„é‡è¦ç»„ä»¶ã€‚